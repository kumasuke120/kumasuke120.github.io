<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="Disclaimer: Although all articles of this series and all related codes are original, the basic idea of the nio server was taking this project on GitHub as a reference.   This is not the first article">
<meta name="keywords" content="Java,Non-blocking IO,HTTP Protocol,Build an NIO HTTP Server">
<meta property="og:type" content="article">
<meta property="og:title" content="Build an NIO HTTP Server, Part 5 Server">
<meta property="og:url" content="https://blog.kumasuke.app/2018/09/19/build-an-nio-http-server-5-server/index.html">
<meta property="og:site_name" content="Kumasuke&#39;s Blog">
<meta property="og:description" content="Disclaimer: Although all articles of this series and all related codes are original, the basic idea of the nio server was taking this project on GitHub as a reference.   This is not the first article">
<meta property="og:locale" content="en-US">
<meta property="og:image" content="https://i.creativecommons.org/l/by-sa/4.0/88x31.png">
<meta property="og:updated_time" content="2018-10-19T12:13:27.984Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Build an NIO HTTP Server, Part 5 Server">
<meta name="twitter:description" content="Disclaimer: Although all articles of this series and all related codes are original, the basic idea of the nio server was taking this project on GitHub as a reference.   This is not the first article">
<meta name="twitter:image" content="https://i.creativecommons.org/l/by-sa/4.0/88x31.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Build an NIO HTTP Server, Part 5 Server</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" href="/2018/08/10/build-an-nio-http-server-4-protocol-processor/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://blog.kumasuke.app/2018/09/19/build-an-nio-http-server-5-server/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://blog.kumasuke.app/2018/09/19/build-an-nio-http-server-5-server/&text=Build an NIO HTTP Server, Part 5 Server"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://blog.kumasuke.app/2018/09/19/build-an-nio-http-server-5-server/&title=Build an NIO HTTP Server, Part 5 Server"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://blog.kumasuke.app/2018/09/19/build-an-nio-http-server-5-server/&is_video=false&description=Build an NIO HTTP Server, Part 5 Server"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Build an NIO HTTP Server, Part 5 Server&body=Check out this article: https://blog.kumasuke.app/2018/09/19/build-an-nio-http-server-5-server/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://blog.kumasuke.app/2018/09/19/build-an-nio-http-server-5-server/&title=Build an NIO HTTP Server, Part 5 Server"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://blog.kumasuke.app/2018/09/19/build-an-nio-http-server-5-server/&title=Build an NIO HTTP Server, Part 5 Server"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://blog.kumasuke.app/2018/09/19/build-an-nio-http-server-5-server/&title=Build an NIO HTTP Server, Part 5 Server"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://blog.kumasuke.app/2018/09/19/build-an-nio-http-server-5-server/&title=Build an NIO HTTP Server, Part 5 Server"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://blog.kumasuke.app/2018/09/19/build-an-nio-http-server-5-server/&name=Build an NIO HTTP Server, Part 5 Server&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#ConnectionAcceptor"><span class="toc-number">1.</span> <span class="toc-text">ConnectionAcceptor</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ConnectionProcessor"><span class="toc-number">2.</span> <span class="toc-text">ConnectionProcessor</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ConnectionDispatcherThread"><span class="toc-number">2.1.</span> <span class="toc-text">ConnectionDispatcherThread</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IO-Queues-and-IO-Threads"><span class="toc-number">2.2.</span> <span class="toc-text">IO Queues and IO Threads</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Assembling"><span class="toc-number">2.3.</span> <span class="toc-text">Assembling</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#To-be-continued…"><span class="toc-number">3.</span> <span class="toc-text">To be continued…</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Build an NIO HTTP Server, Part 5 Server
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Kumasuke's Blog</span>
      </span>
      
    <div class="postdate">
        <time datetime="2018-09-19T12:52:51.000Z" itemprop="datePublished">2018-09-19</time>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/Build-an-NIO-HTTP-Server/">Build an NIO HTTP Server</a>, <a class="tag-link" href="/tags/HTTP-Protocol/">HTTP Protocol</a>, <a class="tag-link" href="/tags/Java/">Java</a>, <a class="tag-link" href="/tags/Non-blocking-IO/">Non-blocking IO</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <blockquote>
<p><em>Disclaimer</em>: Although all articles of this series and all related codes are original, the basic idea of the nio server was taking <a href="https://github.com/jjenkov/java-nio-server/tree/master/src/main/java/com/jenkov/nioserver" target="_blank" rel="noopener">this project</a> on GitHub as a reference.</p>
</blockquote>
<blockquote>
<p>This is not the first article of <a href="https://blog.kumasuke.app/tags/Build-an-NIO-HTTP-Server/">this series</a>, click <a href="https://blog.kumasuke.app/2018/07/12/build-an-nio-http-server-0-prerequisite/">here</a> to see the first article of this series.</p>
</blockquote>
<p>In the last part, we have seen through the Protocol Processor part of our NIO Server. Let’s take a look at the server part.</p>
<p>As we have mentioned in the previous articles, the Server part contains two main parts: <code>ConnectionAcceptor</code> and <code>ConnectionProcessor</code>. Easy one goes first, let us build the <code>ConnectionAcceptor</code> from scratch.</p>
<h2 id="ConnectionAcceptor"><a href="#ConnectionAcceptor" class="headerlink" title="ConnectionAcceptor"></a><code>ConnectionAcceptor</code></h2><p>A <code>ConnectionAcceptor</code> is a class contains solely one thread whose job is to accept incoming connections and to put them into the queue. The thread could be stopped by setting a <code>volatile</code> variable.<br>Here is the code for the specific class, which is an inner class of the <code>ConnectionProcessor</code> class:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConnectionAccepter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = </span><br><span class="line">                LoggerFactory.getLogger(ConnectionAccepter.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Config config;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ServerSocketChannel serverSocketChannel;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;Connection&gt; connectionQueue;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Thread accepterThread;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> isRunning = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    ConnectionAccepter(<span class="meta">@Nonnull</span> Config config,</span><br><span class="line">                       <span class="meta">@Nonnull</span> ServerSocketChannel serverSocketChannel,</span><br><span class="line">                       <span class="meta">@Nonnull</span> BlockingQueue&lt;Connection&gt; connectionQueue) &#123;</span><br><span class="line">        <span class="keyword">this</span>.config = config;</span><br><span class="line">        <span class="keyword">this</span>.serverSocketChannel = serverSocketChannel;</span><br><span class="line">        <span class="keyword">this</span>.connectionQueue = connectionQueue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        accepterThread = <span class="keyword">new</span> AcceptThread();</span><br><span class="line">        accepterThread.start();</span><br><span class="line">        isRunning = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        logger.debug(<span class="string">"ConnectionAccepter started"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        isRunning = <span class="keyword">false</span>;</span><br><span class="line">        accepterThread = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        logger.debug(<span class="string">"ConnectionAccepter stopped"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">AcceptThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">long</span> currentConnectionId = <span class="number">0L</span>;</span><br><span class="line"></span><br><span class="line">        AcceptThread() &#123;</span><br><span class="line">            <span class="keyword">super</span>(config.getServerNameWithoutVersion() + <span class="string">"-ConnectionAccepter"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">while</span> (isRunning) &#123;</span><br><span class="line">                <span class="keyword">final</span> SocketChannel socketChannel;</span><br><span class="line">                <span class="keyword">final</span> SocketAddress remoteAddress;</span><br><span class="line">                <span class="keyword">final</span> SocketAddress localAddress;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    socketChannel = serverSocketChannel.accept();</span><br><span class="line">                    remoteAddress = socketChannel.getRemoteAddress();</span><br><span class="line">                    localAddress = socketChannel.getLocalAddress();</span><br><span class="line">                    socketChannel.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    logger.error(<span class="string">"error encountered when accepting socket"</span>, e);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">final</span> var conn = </span><br><span class="line">                    <span class="keyword">new</span> Connection(++currentConnectionId, socketChannel);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    connectionQueue.put(conn);</span><br><span class="line"></span><br><span class="line">                    logger.info</span><br><span class="line">                        (<span class="string">"a new connection built: Connection#&#123;&#125;(&#123;&#125; -&gt; &#123;&#125;)"</span>, </span><br><span class="line">                         conn.id(), remoteAddress, localAddress);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    ConnectionAccepter.<span class="keyword">this</span>.stop();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>We accept <code>SocketChannel</code>s and wrap them into a <code>Connection</code> with newly-generated connection id. We don’t care the overflow problem of the <code>long</code>-typed connection id, because it still big enough to create unique connection ids at any time of the execution. Besides, <code>remoteAddress</code> and <code>localAddress</code> will be retrieved for recording only.</p>
<h2 id="ConnectionProcessor"><a href="#ConnectionProcessor" class="headerlink" title="ConnectionProcessor"></a><code>ConnectionProcessor</code></h2><p><code>ConnectionProcessor</code> is a bit more complicated. It has a special Dispatcher thread and a few IO threads. And also, it is an inner class of <code>ConnectionProcessor</code>.</p>
<h3 id="ConnectionDispatcherThread"><a href="#ConnectionDispatcherThread" class="headerlink" title="ConnectionDispatcherThread"></a><code>ConnectionDispatcherThread</code></h3><p>Let us implement the aforementioned Dispatcher thread first.<br>Dispatcher thread takes <code>Connection</code>s from the queue where <code>ConnectionAccepter</code> puts things, and delivers them into corresponding IO Queues. The following snippet shows what it does:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getIOThreadIndex</span><span class="params">(Connection conn)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">int</span>) (Math.abs(conn.id()) % IO_THREAD_COUNT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ConnectionDispatcherThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    ConnectionDispatcherThread() &#123;</span><br><span class="line">        <span class="keyword">super</span>(config.getServerNameWithoutVersion() + <span class="string">"-ConnectionDispatcher"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (isRunning) &#123;</span><br><span class="line">            <span class="keyword">final</span> Connection conn;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                conn = connectionQueue.take();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                isRunning = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> ioThreadIndex = getIOThreadIndex(conn);</span><br><span class="line">            inboundQueues.get(ioThreadIndex).add(conn);</span><br><span class="line">            logger.debug(</span><br><span class="line">                <span class="string">"connection has dispatched to io thread: Connection#&#123;&#125; -&gt; IO#&#123;&#125;"</span>,</span><br><span class="line">                conn.id(), ioThreadIndex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>As we have brought up, what it does is like some sorts of load balancer. It dispatches <code>Connection</code> based on its id by putting them into the corresponding queue. Next, let me show you how the IO Queues and IO Threads stack up.</p>
<h3 id="IO-Queues-and-IO-Threads"><a href="#IO-Queues-and-IO-Threads" class="headerlink" title="IO Queues and IO Threads"></a>IO Queues and IO Threads</h3><p>IO Threads are the most important parts in the <code>ConnectionProcessor</code>. Each IO Thread has its own inbound queue and outbound queue. We will choose <code>ConcurrentLinkedQueue</code> as IO Queues. Here is its creation and corresponding fields:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;Queue&lt;Connection&gt;&gt; inboundQueues;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;Queue&lt;Connection&gt;&gt; outboundQueues;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> List&lt;Queue&lt;Connection&gt;&gt; createIOQueues() &#123;</span><br><span class="line">    <span class="keyword">final</span> var tmp = <span class="keyword">new</span> ArrayList&lt;Queue&lt;Connection&gt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; IO_THREAD_COUNT; i++) &#123;</span><br><span class="line">        tmp.add(<span class="keyword">new</span> ConcurrentLinkedQueue&lt;&gt;());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Collections.unmodifiableList(tmp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>After seeing the IO Queues, it should have been the time for us to take a look at the <code>IOThread</code>. However, as you may have expected, the <code>IOThread</code> is rather complex. Let’s see the structure of it in the first place, and then build it step by step.<br>As you may have expected, <code>IOThread</code> also resides in the <code>ConnectionProcessor</code>.<br>Here is the skeleton of our <code>IOThread</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">IOThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="comment">// omits static final fields...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> index;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Selector readSelector;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Selector writeSelector;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Long, ConnectionReader&gt; readers;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Long, ConnectionWriter&gt; writers;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Pair&lt;Connection, Future&lt;Object&gt;&gt;&gt; submittedTasks;</span><br><span class="line"></span><br><span class="line">    IOThread(<span class="keyword">int</span> index) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">super</span>(config.getServerNameWithoutVersion() + <span class="string">"-IO-"</span> + index);</span><br><span class="line">        <span class="comment">// omits fields initialization</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (isRunning) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                pollFromInboundQueue();</span><br><span class="line">                readFromSelectedConnections();</span><br><span class="line"></span><br><span class="line">                checkSubmittedTasks();</span><br><span class="line"></span><br><span class="line">                pollFromOutboundQueue();</span><br><span class="line">                writeToSelectedConnections();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">                logger.error(<span class="string">"unexpected error encountered"</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// prevents endless loop wasting cpu time</span></span><br><span class="line">                Thread.sleep(<span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                isRunning = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// omits concrete implementations of methods</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>This kind of thread just run its task in a infinite loop. At the end of each iteration, we put a <code>Thread.sleep()</code> to let the context-switch begin. In addition, We could find out that there are 5 main steps in each iteration. We will take a look at each of them in the following sections. Firstly, let us learn about what these five steps do:</p>
<ul>
<li><code>pollFromInboundQueue</code>: It takes connections out of the related IO Inbound Queue, and adds them into <code>Selector</code> preparing for being read.</li>
<li><code>readFromSelectedConnections</code>: It reads bytes from <code>Connection</code>s in <code>Selector</code> by the means of <code>ConnectionReader</code>. The <code>ConnectionReader</code> will generate a protocol-related request object if the bytes read are enough to build one subsequently. At last, The protocol-related object will be submitted for processing.</li>
<li><code>checkSubmittedTasks</code>: It checks if there is any submitted task (i.e. processing the protocol-related request objects) which has been finished. If there is any finished task, it will take on the duty of attaching the protocol-related response object onto the corresponding <code>Connection</code> and then putting the <code>Connection</code> into the related IO Outbound Queue.</li>
<li><code>pollFromOutboundQueue</code>: It takes connections out of the related IO Outbound Queue, and adds them into <code>Selector</code> preparing for being written.</li>
<li><code>writeToSelectedConnections</code>: It writes bytes into <code>Connection</code>s in <code>Selector</code> by the means of <code>ConnectionWriter</code>. The <code>ConnectionWriter</code> will convert the a protocol-related response object to bytes accordingly, in order to be able to be written.</li>
</ul>
<p>Let us implement <code>pollFromInboundQueue</code> and <code>pollFromOutboundQueue</code>. We implement these two methods together cause they share almost same code snippets:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">IOThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_POLL_SIZE = <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> index;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Selector readSelector;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Selector writeSelector;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// omits unrelated code snippets...</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">pollFromInboundQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;Connection&gt; connections = pollConnectionsFromQueue(inboundQueues);</span><br><span class="line">        registerConnectionsToSelector(connections, </span><br><span class="line">                                      readSelector, SelectionKey.OP_READ);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">pollFromOutboundQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;Connection&gt; connections = pollConnectionsFromQueue(outboundQueues);</span><br><span class="line">        registerConnectionsToSelector(connections, </span><br><span class="line">                                      writeSelector, SelectionKey.OP_WRITE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Connection&gt; pollConnectionsFromQueue</span><br><span class="line">        (List&lt;Queue&lt;Connection&gt;&gt; queues) &#123;</span><br><span class="line">        <span class="keyword">final</span> Queue&lt;Connection&gt; theQueue = queues.get(index);</span><br><span class="line"></span><br><span class="line">        List&lt;Connection&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(MAX_POLL_SIZE);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> pollCount = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (pollCount &lt; MAX_POLL_SIZE) &#123;</span><br><span class="line">            <span class="keyword">final</span> Connection conn = theQueue.poll();</span><br><span class="line">            <span class="keyword">if</span> (conn != <span class="keyword">null</span>) &#123;</span><br><span class="line">                pollCount += <span class="number">1</span>;</span><br><span class="line">                result.add(conn);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">break</span>;  <span class="comment">// fail-fast </span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerConnectionsToSelector</span><span class="params">(List&lt;Connection&gt; connections, </span></span></span><br><span class="line"><span class="function"><span class="params">        Selector dstSelector, <span class="keyword">int</span> operation)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (Connection conn : connections) &#123;</span><br><span class="line">            SocketChannel socketChannel = conn.socketChannel();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                socketChannel.register(dstSelector, operation, conn);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ClosedChannelException e) &#123;</span><br><span class="line">                logger.warn(<span class="string">"channel already closed when starting processing"</span>, </span><br><span class="line">                            e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// omits unrelated code snippets...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>The main purpose of both methods is quite same, so we extract two utility methods <code>pollConnectionsFromQueue</code> and <code>registerConnectionsToSelector</code>. We first get the needed IO Queue, poll the queue for <code>Connection</code> and register the <code>SocketChannel</code> to the <code>Selector</code> at last. We will only loop this procedure at most <code>MAX_POLL_SIZE</code> times to prevent the following methods not being executed.</p>
<p>Next, let us implement <code>readFromSelectedConnections</code> and <code>writeToSelectedConnections</code>. They also share a lot of logic here.<br>We will take a look at their common parts first:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">IOThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="comment">// omits fields...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Selector readSelector;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Selector writeSelector;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// omits fields and methods...</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readFromSelectedConnections</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        doSelectOnSelector(readSelector, <span class="keyword">this</span>::readBySelectionKey);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeToSelectedConnections</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        doSelectOnSelector(writeSelector, <span class="keyword">this</span>::writeBySelectionKey);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doSelectOnSelector</span><span class="params">(Selector selector, </span></span></span><br><span class="line"><span class="function"><span class="params">        Consumer&lt;SelectionKey&gt; consumer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> nSelected;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            nSelected = selector.selectNow();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            logger.error(<span class="string">"error encountered when selecting connections"</span>, e);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nSelected &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> Set&lt;SelectionKey&gt; keys = selector.selectedKeys();</span><br><span class="line">            <span class="keyword">final</span> Iterator&lt;SelectionKey&gt; it = keys.iterator();</span><br><span class="line">            <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">                <span class="keyword">final</span> SelectionKey key = it.next();</span><br><span class="line">                consumer.accept(key);</span><br><span class="line">                it.remove();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// omits methods...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>The idea here is simple, we iterate over the selected <code>SelectionKey</code>s and perform some operations on these keys. We perform the <code>Iterator#remove()</code> at last, because the Set returned by <code>Selector#selectedKeys()</code> won’t be cleared between two adjacent invocations.<br>You could find out that <code>readFromSelectedConnections</code> and <code>writeToSelectedConnections</code> both have their own custom consumer methods, we will implement them in the next section.<br>We will implement <code>readBySelectionKey</code> first:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">IOThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="comment">// omits fields...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Long, ConnectionReader&gt; readers;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Long, ConnectionWriter&gt; writers;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// omits fields and methods...</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readBySelectionKey</span><span class="params">(SelectionKey key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> var conn = (Connection) key.attachment();</span><br><span class="line">        <span class="keyword">final</span> ConnectionReader reader = getReader(conn);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> needCancel = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> nBytesRead = reader.read(conn);</span><br><span class="line">            <span class="keyword">if</span> (nBytesRead &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (reader.hasNext()) &#123;</span><br><span class="line">                    <span class="keyword">final</span> Object protocolObject = reader.next();</span><br><span class="line">                    <span class="keyword">final</span> Future&lt;Object&gt; future = </span><br><span class="line">                        submitProtocolObjectProcessTask(protocolObject);</span><br><span class="line">                    submittedTasks.add(<span class="keyword">new</span> Pair&lt;&gt;(conn, future));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            logger.warn</span><br><span class="line">                (<span class="string">"error encountered when reading from connection: Connection#"</span> + </span><br><span class="line">                    conn.id(), e);</span><br><span class="line">            needCancel = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (EndOfStreamException e) &#123;</span><br><span class="line">            logger.info(<span class="string">"connection has been closed: Connection#&#123;&#125;"</span>, conn.id());</span><br><span class="line">            needCancel = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (needCancel) &#123;</span><br><span class="line">            key.cancel();</span><br><span class="line">            close(conn);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ConnectionReader <span class="title">getReader</span><span class="params">(Connection conn)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> readers.computeIfAbsent(conn.id(), </span><br><span class="line">            k -&gt; protocolFactory.newConnectionReader());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(Connection conn)</span> </span>&#123;</span><br><span class="line">        readers.remove(conn.id());</span><br><span class="line">        writers.remove(conn.id());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            conn.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">            logger.warn(</span><br><span class="line">                <span class="string">"error encountered when closing connection: Connection#"</span> + </span><br><span class="line">                conn.id(), ioe);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// omits methods...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>The code above is quite easy to understand. We let <code>ConnectionReader</code> read bytes and test if has full protocol-related request object, we will get any generated request object add submit it to worker thread. Besides, we also close the <code>Connection</code> when we cancel its selection.<br>Worker Threads are the threads that perform processing tasks. In our case, they are responsible for find the resources on our disks and read it to generate response object, which we have seen and learnt in the <code>HttpProtocolObjectProcessor</code> mentioned in the last article. It is created by <code>HttpProtocolFactory</code> we created which is a field called <code>protocolFactory</code> in <code>ConnectionProcessor</code>.<br>Here let us learn about these Worker Threads briefly:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConnectionProcessor</span> </span>&#123;</span><br><span class="line">    <span class="comment">// omits fields...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ProtocolObjectProcessor protocolObjectProcessor;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// omits fields...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ExecutorService workerThreads;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// omits fields and methods...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Future&lt;Object&gt; submitProtocolObjectProcessTask</span><br><span class="line">        (Object protocolObject) &#123;</span><br><span class="line">        <span class="keyword">final</span> var task = <span class="keyword">new</span> ProtocolObjectProcessTask(protocolObject);</span><br><span class="line">        <span class="keyword">return</span> workerThreads.submit(task);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// omits methods and inner classes...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ProtocolObjectProcessTask</span> <span class="keyword">implements</span> <span class="title">Callable</span>&lt;<span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Object protocolObject;</span><br><span class="line"></span><br><span class="line">        ProtocolObjectProcessTask(Object protocolObject) &#123;</span><br><span class="line">            <span class="keyword">this</span>.protocolObject = protocolObject;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">call</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> protocolObjectProcessor.process(protocolObject);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// omits inner classes...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>The code above describes how we submit our task to the worker threads, we are not going to bother to elaborate on these code snippets. Let’s go back and see how we implement our <code>writeBySelectionKey</code> method in the <code>IOThread</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">IOThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="comment">// omits fields...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Long, ConnectionReader&gt; readers;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Long, ConnectionWriter&gt; writers;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// omits fields and methods...</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeBySelectionKey</span><span class="params">(SelectionKey key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> var conn = (Connection) key.attachment();</span><br><span class="line">        <span class="keyword">final</span> ConnectionWriter writer = getWriter(conn);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> needCancel = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> nBytesWrite = writer.write(conn);</span><br><span class="line">            <span class="keyword">if</span> (nBytesWrite == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// no need to close connection here, lest later requests</span></span><br><span class="line">                <span class="comment">// should create an new connection</span></span><br><span class="line">                needCancel = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            logger.error(</span><br><span class="line">                <span class="string">"error encountered when writing to connection: Connection#"</span> + </span><br><span class="line">                conn.id(), e);</span><br><span class="line">            close(conn);</span><br><span class="line">            needCancel = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">            logger.error(</span><br><span class="line">                <span class="string">"error encountered when writing to connection: Connection#"</span> + </span><br><span class="line">                conn.id(), e);</span><br><span class="line">            needCancel = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (needCancel) &#123;</span><br><span class="line">            key.cancel();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ConnectionWriter <span class="title">getWriter</span><span class="params">(Connection conn)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> writers.computeIfAbsent(conn.id(), </span><br><span class="line">            k -&gt; protocolFactory.newConnectionWriter());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(Connection conn)</span> </span>&#123;</span><br><span class="line">        readers.remove(conn.id());</span><br><span class="line">        writers.remove(conn.id());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            conn.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">            logger.warn(</span><br><span class="line">                <span class="string">"error encountered when closing connection: Connection#"</span> + </span><br><span class="line">                conn.id(), ioe);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// omits methods...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>The write-related code is rather simple to understand. What we should take care of is that we won’t close the <code>Connection</code> unless it is closed by the remote client. However, we surely will cancel the selection if we have written all data bytes into the <code>Connection</code>. </p>
<p>At last, we need to implement <code>checkSubmittedTasks</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkSubmittedTasks</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Iterator&lt;Pair&lt;Connection, Future&lt;Object&gt;&gt;&gt; it = </span><br><span class="line">        submittedTasks.iterator();</span><br><span class="line">    <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">        <span class="keyword">final</span> Pair&lt;Connection, Future&lt;Object&gt;&gt; pair = it.next();</span><br><span class="line">        <span class="keyword">final</span> var conn = pair.getFirst();</span><br><span class="line">        <span class="keyword">final</span> var future = pair.getSecond();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (future.isDone()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">final</span> Object returnObject = future.get();</span><br><span class="line">                <span class="keyword">final</span> ConnectionWriter writer = getWriter(conn);</span><br><span class="line"></span><br><span class="line">                writer.add(returnObject);</span><br><span class="line">                outboundQueues.get(getIOThreadIndex(conn)).add(conn);</span><br><span class="line">                logger.debug(</span><br><span class="line">                    <span class="string">"process finished: Connection#&#123;&#125;"</span>, </span><br><span class="line">                    conn.id());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                isRunning = <span class="keyword">false</span>;</span><br><span class="line">                Thread.currentThread().interrupt();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</span><br><span class="line">                <span class="keyword">final</span> Throwable cause = e.getCause();</span><br><span class="line">                logger.warn(</span><br><span class="line">                    <span class="string">"error encountered when processing "</span> + </span><br><span class="line">                    <span class="string">"message from connection: Connection#"</span> +</span><br><span class="line">                    conn.id(), cause);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                it.remove();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>This is how we deal with finished task. Through the <code>Pair</code>, we connect the <code>Connection</code> and the protocol-related response object and are able to add the response object to queue of pending-written objects.<br>Thats’ all for our <code>IOThread</code>. Let’s up piece together all sub-components we have built to create the <code>ConnectionProcessor</code>.</p>
<h3 id="Assembling"><a href="#Assembling" class="headerlink" title="Assembling"></a>Assembling</h3><p>To assemble the sub-components we have created, we need to write a little bit of glue code.<br>The following code snippet demonstrates the <code>ConnectionProcessor</code> (formerly-mentioned code have been omitted):<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConnectionProcessor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = </span><br><span class="line">        LoggerFactory.getLogger(ConnectionProcessor.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MIN_IO_THREAD_COUNT = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> IO_THREAD_COUNT = </span><br><span class="line">        Math.min(MIN_IO_THREAD_COUNT,</span><br><span class="line">                 Runtime.getRuntime().availableProcessors() / <span class="number">3</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CORE_WORKER_THREAD_COUNT = </span><br><span class="line">        Runtime.getRuntime().availableProcessors();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_WORKER_THREAD_COUNT = </span><br><span class="line">        Runtime.getRuntime().availableProcessors() * <span class="number">2</span> + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Config config;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ProtocolFactory protocolFactory;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ProtocolObjectProcessor protocolObjectProcessor;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;Connection&gt; connectionQueue;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Queue&lt;Connection&gt;&gt; inboundQueues;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Queue&lt;Connection&gt;&gt; outboundQueues;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Thread[] ioThreads;</span><br><span class="line">    <span class="keyword">private</span> ExecutorService workerThreads;</span><br><span class="line">    <span class="keyword">private</span> Thread dispatcherThread;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> isRunning = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    ConnectionProcessor(<span class="meta">@Nonnull</span> Config config,</span><br><span class="line">                        <span class="meta">@Nonnull</span> ProtocolFactory protocolFactory,</span><br><span class="line">                        <span class="meta">@Nonnull</span> BlockingQueue&lt;Connection&gt; connectionQueue) &#123;</span><br><span class="line">        <span class="keyword">this</span>.config = config;</span><br><span class="line">        <span class="keyword">this</span>.protocolFactory = protocolFactory;</span><br><span class="line">        <span class="keyword">this</span>.protocolObjectProcessor = </span><br><span class="line">            protocolFactory.newProtocolObjectProcessor(config);</span><br><span class="line">        <span class="keyword">this</span>.connectionQueue = connectionQueue;</span><br><span class="line">        <span class="keyword">this</span>.inboundQueues = createIOQueues();</span><br><span class="line">        <span class="keyword">this</span>.outboundQueues = createIOQueues();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Queue&lt;Connection&gt;&gt; createIOQueues()  &#123; <span class="comment">/* omits here... */</span> &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        isRunning = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        dispatcherThread = <span class="keyword">new</span> ConnectionDispatcherThread();</span><br><span class="line">        dispatcherThread.start();</span><br><span class="line"></span><br><span class="line">        ioThreads = <span class="keyword">new</span> Thread[IO_THREAD_COUNT];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; IO_THREAD_COUNT; i++) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ioThreads[i] = <span class="keyword">new</span> IOThread(i);</span><br><span class="line">                ioThreads[i].start();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                logger.error(<span class="string">"cannot create io thread"</span>, e);</span><br><span class="line">                isRunning = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.workerThreads = </span><br><span class="line">            <span class="keyword">new</span> ThreadPoolExecutor(CORE_WORKER_THREAD_COUNT, </span><br><span class="line">                                   MAX_WORKER_THREAD_COUNT,</span><br><span class="line">                                   <span class="number">60L</span>, TimeUnit.SECONDS,</span><br><span class="line">                                   <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;(),</span><br><span class="line">                                   <span class="keyword">new</span> WorkerThreadFactory());</span><br><span class="line"></span><br><span class="line">        logger.debug(<span class="string">"ConnectionProcessor started"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        isRunning = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (dispatcherThread.isAlive()) &#123;</span><br><span class="line">            dispatcherThread.interrupt();</span><br><span class="line">            dispatcherThread = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; IO_THREAD_COUNT; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ioThreads[i].isAlive()) &#123;</span><br><span class="line">                ioThreads[i].interrupt();</span><br><span class="line">                ioThreads[i] = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        workerThreads.shutdownNow();</span><br><span class="line">        workerThreads = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        logger.debug(<span class="string">"ConnectionProcessor stopped"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getIOThreadIndex</span><span class="params">(Connection conn)</span> </span>&#123; <span class="comment">/* omits here... */</span> &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Future&lt;Object&gt; submitProtocolObjectProcessTask</span><br><span class="line">        (Object protocolObject) &#123; <span class="comment">/* omits here... */</span> &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ConnectionDispatcherThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">        <span class="comment">// omits here...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">IOThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">        <span class="comment">// omits here...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ProtocolObjectProcessTask</span> <span class="keyword">implements</span> <span class="title">Callable</span>&lt;<span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line">        <span class="comment">// omits here...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">WorkerThreadFactory</span> <span class="keyword">implements</span> <span class="title">ThreadFactory</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger threadNumber;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> ThreadGroup group;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String namePrefix;</span><br><span class="line"></span><br><span class="line">        WorkerThreadFactory() &#123;</span><br><span class="line">            SecurityManager s = System.getSecurityManager();</span><br><span class="line">            <span class="keyword">this</span>.threadNumber = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line">            group = (s != <span class="keyword">null</span>) ? s.getThreadGroup() : </span><br><span class="line">                Thread.currentThread().getThreadGroup();</span><br><span class="line">            namePrefix = config.getServerNameWithoutVersion() + <span class="string">"-Worker-"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Thread <span class="title">newThread</span><span class="params">(@Nonnull Runnable r)</span> </span>&#123;</span><br><span class="line">            Thread t = </span><br><span class="line">                <span class="keyword">new</span> Thread(group, r, </span><br><span class="line">                           namePrefix + threadNumber.incrementAndGet());</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (t.isDaemon()) &#123;</span><br><span class="line">                t.setDaemon(<span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (t.getPriority() != Thread.NORM_PRIORITY) &#123;</span><br><span class="line">                t.setPriority(Thread.NORM_PRIORITY);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> t;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>That’s all for our <code>ConnectionProcessor</code>.</p>
<h2 id="To-be-continued…"><a href="#To-be-continued…" class="headerlink" title="To be continued…"></a>To be continued…</h2><p>In this article, we have fully implemented the Server part of our NIO Server. In next part, we will assemble all the components and finish our server. We will also test it using the static resources of this blog.</p>
<hr style="margin-bottom: 20px; margin-top: 35px"> <img alt="Creative Commons License" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png"><br> <b style="color: #2bbc8a">This original article is licensed under a <a target="_blank" href="http://creativecommons.org/licenses/by-sa/4.0/"> Creative Commons Attribution 4.0 International License</a>.</b><br><br> <b style="color: #2bbc8a">Title: </b>Build an NIO HTTP Server, Part 5 Server<br> <b style="color: #2bbc8a">Permalink: </b><a href="https://blog.kumasuke.app/2018/09/19/build-an-nio-http-server-5-server/" target="_blank">https://blog.kumasuke.app/2018/09/19/build-an-nio-http-server-5-server/</a>
  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#ConnectionAcceptor"><span class="toc-number">1.</span> <span class="toc-text">ConnectionAcceptor</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ConnectionProcessor"><span class="toc-number">2.</span> <span class="toc-text">ConnectionProcessor</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ConnectionDispatcherThread"><span class="toc-number">2.1.</span> <span class="toc-text">ConnectionDispatcherThread</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IO-Queues-and-IO-Threads"><span class="toc-number">2.2.</span> <span class="toc-text">IO Queues and IO Threads</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Assembling"><span class="toc-number">2.3.</span> <span class="toc-text">Assembling</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#To-be-continued…"><span class="toc-number">3.</span> <span class="toc-text">To be continued…</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://blog.kumasuke.app/2018/09/19/build-an-nio-http-server-5-server/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://blog.kumasuke.app/2018/09/19/build-an-nio-http-server-5-server/&text=Build an NIO HTTP Server, Part 5 Server"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://blog.kumasuke.app/2018/09/19/build-an-nio-http-server-5-server/&title=Build an NIO HTTP Server, Part 5 Server"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://blog.kumasuke.app/2018/09/19/build-an-nio-http-server-5-server/&is_video=false&description=Build an NIO HTTP Server, Part 5 Server"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Build an NIO HTTP Server, Part 5 Server&body=Check out this article: https://blog.kumasuke.app/2018/09/19/build-an-nio-http-server-5-server/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://blog.kumasuke.app/2018/09/19/build-an-nio-http-server-5-server/&title=Build an NIO HTTP Server, Part 5 Server"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://blog.kumasuke.app/2018/09/19/build-an-nio-http-server-5-server/&title=Build an NIO HTTP Server, Part 5 Server"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://blog.kumasuke.app/2018/09/19/build-an-nio-http-server-5-server/&title=Build an NIO HTTP Server, Part 5 Server"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://blog.kumasuke.app/2018/09/19/build-an-nio-http-server-5-server/&title=Build an NIO HTTP Server, Part 5 Server"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://blog.kumasuke.app/2018/09/19/build-an-nio-http-server-5-server/&name=Build an NIO HTTP Server, Part 5 Server&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2018 Kumasuke
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/fontawesome-all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'kumasuke-blog';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


