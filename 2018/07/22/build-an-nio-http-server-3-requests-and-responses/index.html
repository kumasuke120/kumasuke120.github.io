<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="Disclaimer: Although all articles of this series and all related codes are original, the basic idea of the nio server was taking this project on GitHub as a reference.   This is not the first article">
<meta name="keywords" content="Java,Non-blocking IO,HTTP Protocol,Build an NIO HTTP Server,Parse HTTP">
<meta property="og:type" content="article">
<meta property="og:title" content="Build an NIO HTTP Server, Part 3 Requests and Responses">
<meta property="og:url" content="https://blog.kumasuke.app/2018/07/22/build-an-nio-http-server-3-requests-and-responses/index.html">
<meta property="og:site_name" content="Kumasuke&#39;s Blog">
<meta property="og:description" content="Disclaimer: Although all articles of this series and all related codes are original, the basic idea of the nio server was taking this project on GitHub as a reference.   This is not the first article">
<meta property="og:locale" content="en-US">
<meta property="og:image" content="https://i.creativecommons.org/l/by-sa/4.0/88x31.png">
<meta property="og:updated_time" content="2018-07-28T14:26:31.768Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Build an NIO HTTP Server, Part 3 Requests and Responses">
<meta name="twitter:description" content="Disclaimer: Although all articles of this series and all related codes are original, the basic idea of the nio server was taking this project on GitHub as a reference.   This is not the first article">
<meta name="twitter:image" content="https://i.creativecommons.org/l/by-sa/4.0/88x31.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Build an NIO HTTP Server, Part 3 Requests and Responses</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2018/08/10/build-an-nio-http-server-4-protocol-processor/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2018/07/18/build-an-nio-http-server-2-utilities/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://blog.kumasuke.app/2018/07/22/build-an-nio-http-server-3-requests-and-responses/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://blog.kumasuke.app/2018/07/22/build-an-nio-http-server-3-requests-and-responses/&text=Build an NIO HTTP Server, Part 3 Requests and Responses"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://blog.kumasuke.app/2018/07/22/build-an-nio-http-server-3-requests-and-responses/&title=Build an NIO HTTP Server, Part 3 Requests and Responses"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://blog.kumasuke.app/2018/07/22/build-an-nio-http-server-3-requests-and-responses/&is_video=false&description=Build an NIO HTTP Server, Part 3 Requests and Responses"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Build an NIO HTTP Server, Part 3 Requests and Responses&body=Check out this article: https://blog.kumasuke.app/2018/07/22/build-an-nio-http-server-3-requests-and-responses/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://blog.kumasuke.app/2018/07/22/build-an-nio-http-server-3-requests-and-responses/&title=Build an NIO HTTP Server, Part 3 Requests and Responses"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://blog.kumasuke.app/2018/07/22/build-an-nio-http-server-3-requests-and-responses/&title=Build an NIO HTTP Server, Part 3 Requests and Responses"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://blog.kumasuke.app/2018/07/22/build-an-nio-http-server-3-requests-and-responses/&title=Build an NIO HTTP Server, Part 3 Requests and Responses"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://blog.kumasuke.app/2018/07/22/build-an-nio-http-server-3-requests-and-responses/&title=Build an NIO HTTP Server, Part 3 Requests and Responses"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://blog.kumasuke.app/2018/07/22/build-an-nio-http-server-3-requests-and-responses/&name=Build an NIO HTTP Server, Part 3 Requests and Responses&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Meet-with-HttpRequest-and-HttpResponse"><span class="toc-number">1.</span> <span class="toc-text">Meet with HttpRequest and HttpResponse</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pinpoint-the-endpoint-of-a-raw-HTTP-Request"><span class="toc-number">2.</span> <span class="toc-text">Pinpoint the endpoint of a raw HTTP Request</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Parse-raw-messages-to-HttpRequest"><span class="toc-number">3.</span> <span class="toc-text">Parse raw messages to HttpRequest</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Generates-Bytes-of-HttpResponse"><span class="toc-number">4.</span> <span class="toc-text">Generates Bytes of HttpResponse</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Converts-HttpRequest-to-HttpResponse"><span class="toc-number">5.</span> <span class="toc-text">Converts HttpRequest to HttpResponse</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#To-be-continues…"><span class="toc-number">6.</span> <span class="toc-text">To be continues…</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Build an NIO HTTP Server, Part 3 Requests and Responses
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Kumasuke's Blog</span>
      </span>
      
    <div class="postdate">
        <time datetime="2018-07-22T02:47:11.000Z" itemprop="datePublished">2018-07-22</time>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/Build-an-NIO-HTTP-Server/">Build an NIO HTTP Server</a>, <a class="tag-link" href="/tags/HTTP-Protocol/">HTTP Protocol</a>, <a class="tag-link" href="/tags/Java/">Java</a>, <a class="tag-link" href="/tags/Non-blocking-IO/">Non-blocking IO</a>, <a class="tag-link" href="/tags/Parse-HTTP/">Parse HTTP</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <blockquote>
<p><em>Disclaimer</em>: Although all articles of this series and all related codes are original, the basic idea of the nio server was taking <a href="https://github.com/jjenkov/java-nio-server/tree/master/src/main/java/com/jenkov/nioserver" target="_blank" rel="noopener">this project</a> on GitHub as a reference.</p>
</blockquote>
<blockquote>
<p>This is not the first article of <a href="https://blog.kumasuke.app/tags/Build-an-NIO-HTTP-Server/">this series</a>, click <a href="https://blog.kumasuke.app/2018/07/12/build-an-nio-http-server-0-prerequisite/">here</a> to see the first article of this series.</p>
</blockquote>
<p>In the prerequisite, we have learnt about the format of HTTP Requests and HTTP Responses. Before we begin our actual work, let me introduce all related POJOs first.</p>
<h2 id="Meet-with-HttpRequest-and-HttpResponse"><a href="#Meet-with-HttpRequest-and-HttpResponse" class="headerlink" title="Meet with HttpRequest and HttpResponse"></a>Meet with <code>HttpRequest</code> and <code>HttpResponse</code></h2><p>An <code>HttpRequest</code> contains <code>version</code>, <code>method</code>, <code>requestUri</code>, <code>headers</code> and <code>body</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HttpRequest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String version;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HttpMethod method;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String requestUri;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HttpHeaders headers;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] body;</span><br><span class="line"></span><br><span class="line">    HttpRequest(<span class="meta">@Nonnull</span> HttpMethod method,</span><br><span class="line">                <span class="meta">@Nonnull</span> String requestUri,</span><br><span class="line">                <span class="meta">@Nonnull</span> String version,</span><br><span class="line">                <span class="meta">@Nonnull</span> HttpHeaders headers,</span><br><span class="line">                <span class="meta">@Nonnull</span> <span class="keyword">byte</span>[] body) &#123;</span><br><span class="line">        <span class="keyword">this</span>.method = method;</span><br><span class="line">        <span class="keyword">this</span>.requestUri = requestUri;</span><br><span class="line">        <span class="keyword">this</span>.version = version;</span><br><span class="line">        <span class="keyword">this</span>.headers = headers;</span><br><span class="line">        <span class="keyword">this</span>.body = body;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// omits getters...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>An <code>HttpResponse</code> contains <code>version</code>, <code>status</code>, <code>headers</code> and <code>body</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HttpResponse</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String version;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HttpStatus status;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HttpHeaders headers;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] body;</span><br><span class="line"></span><br><span class="line">    HttpResponse(<span class="meta">@Nonnull</span> String version,</span><br><span class="line">                 <span class="meta">@Nonnull</span> HttpStatus status,</span><br><span class="line">                 <span class="meta">@Nonnull</span> HttpHeaders headers,</span><br><span class="line">                 <span class="meta">@Nonnull</span> <span class="keyword">byte</span>[] body) &#123;</span><br><span class="line">        <span class="keyword">this</span>.version = version;</span><br><span class="line">        <span class="keyword">this</span>.status = status;</span><br><span class="line">        <span class="keyword">this</span>.headers = headers;</span><br><span class="line">        <span class="keyword">this</span>.body = body;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// omits getters...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>In addition, the <code>HttpHeaders</code> is like a <code>Map&lt;String, byte[]&gt;</code> that stores headers of HTTP Message. The <code>String</code> part of the <code>Map</code> stores field key in lowercase, while the <code>byte[]</code> part stores field value in bytes.</p>
<h2 id="Pinpoint-the-endpoint-of-a-raw-HTTP-Request"><a href="#Pinpoint-the-endpoint-of-a-raw-HTTP-Request" class="headerlink" title="Pinpoint the endpoint of a raw HTTP Request"></a>Pinpoint the endpoint of a raw HTTP Request</h2><p>Our server will run in non-blocking mode. That means the client is not likely to send all the raw messages or even a full complete message to the sever during a call to <code>SocketChannel#read()</code>. Thus, after each valid <code>read</code>, we have to detect whether it reaches the end of message in order to pass the message to parser.</p>
<p>We will implement this method in the <code>app.kumasuke.srs.protocol.HttpSupport</code>. Here is the code that implement the function that we have mentioned:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> POSITION_NOT_FOUND = -<span class="number">1</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> String HEADER_CONTENT_LENGTH = <span class="string">"Content-Length"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">findNextEndOfRequest</span><span class="params">(@Nonnull DynamicByteBuffer src)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Http Request Structure:</span></span><br><span class="line"><span class="comment">     *  Request = Request-Line</span></span><br><span class="line"><span class="comment">     *            *(( general-header</span></span><br><span class="line"><span class="comment">     *             | request-header</span></span><br><span class="line"><span class="comment">     *             | entity-header ) CRLF)  ; message-headers</span></span><br><span class="line"><span class="comment">     *            CRLF</span></span><br><span class="line"><span class="comment">     *            [ message-body ]</span></span><br><span class="line"><span class="comment">     * See Also: https://tools.ietf.org/html/rfc2616</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Request-Line</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> endOfRequestLine = findNextEndOfLine(src, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (endOfRequestLine == POSITION_NOT_FOUND) <span class="keyword">return</span> POSITION_NOT_FOUND;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// message-headers</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> endOfHeaders = findNextEndOfHeaders(src, endOfRequestLine);</span><br><span class="line">    <span class="keyword">if</span> (endOfHeaders == POSITION_NOT_FOUND) <span class="keyword">return</span> POSITION_NOT_FOUND;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> contentLength = parseContentLength</span><br><span class="line">                                (src, endOfRequestLine, endOfHeaders);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// message-body</span></span><br><span class="line">    <span class="keyword">if</span> (contentLength == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> endOfHeaders;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> expectedEndOfRequest = endOfHeaders + contentLength;</span><br><span class="line">        <span class="keyword">if</span> (src.length() &gt;= expectedEndOfRequest) &#123;</span><br><span class="line">            <span class="keyword">return</span> expectedEndOfRequest;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> POSITION_NOT_FOUND;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">findNextEndOfLine</span><span class="params">(DynamicByteBuffer src, <span class="keyword">int</span> startIndex)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = startIndex; i &lt; src.length() - <span class="number">1</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (src.get(i) == <span class="string">'\r'</span> &amp;&amp; src.get(i + <span class="number">1</span>) == <span class="string">'\n'</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> i + <span class="number">2</span>;   <span class="comment">// position after the last byte of current line</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> POSITION_NOT_FOUND;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">findNextEndOfHeaders</span><span class="params">(DynamicByteBuffer src, <span class="keyword">int</span> startIndex)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> prevEndOfLine = findNextEndOfLine(src, startIndex);</span><br><span class="line">    <span class="keyword">while</span> (prevEndOfLine != POSITION_NOT_FOUND) &#123;</span><br><span class="line">        <span class="keyword">int</span> nextEndOfLine = findNextEndOfLine(src, prevEndOfLine);</span><br><span class="line">        <span class="keyword">if</span> (nextEndOfLine != POSITION_NOT_FOUND) &#123;</span><br><span class="line">            <span class="keyword">if</span> (prevEndOfLine + <span class="number">2</span> == nextEndOfLine) &#123;   <span class="comment">// current line is empty</span></span><br><span class="line">                <span class="keyword">return</span> nextEndOfLine;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                prevEndOfLine = nextEndOfLine;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> POSITION_NOT_FOUND;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> parseContentLength</span><br><span class="line">    (DynamicByteBuffer src, <span class="keyword">int</span> startIndex, <span class="keyword">int</span> endIndex) &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">byte</span>[] fieldValue = findFieldValueByFieldName(src, </span><br><span class="line">                                                        startIndex, endIndex, </span><br><span class="line">                                                        HEADER_CONTENT_LENGTH);</span><br><span class="line">    <span class="keyword">if</span> (fieldValue.length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> String fieldValueStr = <span class="keyword">new</span> String(fieldValue);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Integer.parseInt(fieldValueStr.trim());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"SameParameterValue"</span>) </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] findFieldValueByFieldName(DynamicByteBuffer src, </span><br><span class="line">                                                <span class="keyword">int</span> startIndex, <span class="keyword">int</span> endIndex,</span><br><span class="line">                                                String fieldName) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = startIndex; i &lt; endIndex; ) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> nextEndOfLine = findNextEndOfLine(src, i);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">assert</span> nextEndOfLine != POSITION_NOT_FOUND;</span><br><span class="line">        <span class="keyword">if</span> (headMatches(src, i, fieldName, <span class="keyword">false</span>)) &#123;</span><br><span class="line">            <span class="comment">// adds 1 to skip colon</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> valueStartIndex = i + fieldName.length() + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> valueLength = nextEndOfLine - <span class="number">1</span> - valueStartIndex;</span><br><span class="line">            <span class="keyword">return</span> src.get(valueStartIndex, valueLength);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        i = nextEndOfLine;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">headMatches</span><span class="params">(DynamicByteBuffer src, </span></span></span><br><span class="line"><span class="function"><span class="params">                                   <span class="keyword">int</span> startIndex, String head,</span></span></span><br><span class="line"><span class="function"><span class="params">                                   <span class="keyword">boolean</span> caseSensitive)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> var headBytes = caseSensitive ? </span><br><span class="line">        head.getBytes() : head.toLowerCase().getBytes();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = startIndex; </span><br><span class="line">         i &lt; src.length() &amp;&amp; i - startIndex &lt; headBytes.length; </span><br><span class="line">        i++) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">char</span> srcChar = caseSensitive ? </span><br><span class="line">            (<span class="keyword">char</span>) src.get(i) : Character.toLowerCase((<span class="keyword">char</span>) src.get(i));</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">char</span> fieldChar = (<span class="keyword">char</span>) headBytes[i - startIndex];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (srcChar != fieldChar) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Strictly follow the augmented BNF, we find the end of an HTTP Request. Besides, we parse the <code>Content-Length</code> header in order to get the length of body. We would return <code>indexOfLastByteInMessage + 1</code> if we find the endpoint. Otherwise, we will just return <code>POSITION_NOT_FOUND</code> to denote failure.</p>
<h2 id="Parse-raw-messages-to-HttpRequest"><a href="#Parse-raw-messages-to-HttpRequest" class="headerlink" title="Parse raw messages to HttpRequest"></a>Parse raw messages to <code>HttpRequest</code></h2><p>Since we have found where is the end of our request, the next step is to parse the raw message to an <code>HttpRequest</code> object. The structure of the code that parses messages is quite same as the one that finds endpoint. What is different is it adds code snippets to parse required values out of bytes.<br>Let’s take a look at the code:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> String HEADER_HOST = <span class="string">"Host"</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Nonnull</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> HttpRequest <span class="title">parseRequest</span><span class="params">(@Nonnull DynamicByteBuffer src)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Http Request Structure:</span></span><br><span class="line"><span class="comment">     *  Request = Request-Line</span></span><br><span class="line"><span class="comment">     *            *(( general-header</span></span><br><span class="line"><span class="comment">     *             | request-header</span></span><br><span class="line"><span class="comment">     *             | entity-header ) CRLF)  ; message-headers</span></span><br><span class="line"><span class="comment">     *            CRLF</span></span><br><span class="line"><span class="comment">     *            [ message-body ]</span></span><br><span class="line"><span class="comment">     * See Also: https://tools.ietf.org/html/rfc2616</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Request-Line:</span></span><br><span class="line"><span class="comment">     *  Request-Line = Method SP Request-URI SP HTTP-Version CRLF</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> endOfRequestLine = findNextEndOfLine(src, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (endOfRequestLine == POSITION_NOT_FOUND) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMessageException(<span class="string">"Cannot parse request as http request"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> HttpMethod method = parseHttpMethod(src);</span><br><span class="line">    <span class="keyword">final</span> String requestUri = parseRequestUri(src);</span><br><span class="line">    <span class="keyword">final</span> String version = parseVersion(src);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// message-headers</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> endOfHeaders = findNextEndOfHeaders(src, endOfRequestLine);</span><br><span class="line">    <span class="keyword">if</span> (endOfHeaders == POSITION_NOT_FOUND) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMessageException(<span class="string">"Cannot parse http headers from request"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> HttpHeaders headers = parseHttpHeaders(src, endOfRequestLine, endOfHeaders);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> contentLength = parseContentLength(src, endOfRequestLine, endOfHeaders);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// message-body</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">byte</span>[] body = contentLength == <span class="number">0</span> ? </span><br><span class="line">        <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>] : src.get(endOfHeaders, contentLength);</span><br><span class="line">    <span class="keyword">return</span> createNewRequest(method, requestUri, version, headers, body);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> HttpMethod <span class="title">parseHttpMethod</span><span class="params">(DynamicByteBuffer src)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (HttpMethod method : HttpMethod.values()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (headMatches(src, <span class="number">0</span>, method.name(), <span class="keyword">true</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> method;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMessageException(<span class="string">"Cannot parse http method from request"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">parseRequestUri</span><span class="params">(DynamicByteBuffer src)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> var builder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> metFirstSpace = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; src.length(); i++) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">byte</span> c = src.get(i);</span><br><span class="line">        <span class="keyword">if</span> (Character.isSpaceChar(c)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (metFirstSpace) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                metFirstSpace = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (metFirstSpace) &#123;</span><br><span class="line">            builder.appendCodePoint(c);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (builder.length() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMessageException(<span class="string">"Cannot parse request uri from request"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> builder.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">parseVersion</span><span class="params">(DynamicByteBuffer src)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String anchor = <span class="string">" HTTP/"</span>;</span><br><span class="line">    <span class="keyword">final</span> var builder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> append = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; src.length(); i++) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">byte</span> c = src.get(i);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (append) &#123;</span><br><span class="line">            <span class="keyword">if</span> (Character.isDigit(c) || c == <span class="string">'.'</span>) &#123;</span><br><span class="line">                builder.appendCodePoint(c);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (anchor.charAt(<span class="number">0</span>) == c &amp;&amp; headMatches(src, i, anchor, <span class="keyword">true</span>)) &#123;</span><br><span class="line">            i += anchor.length() - <span class="number">1</span>;</span><br><span class="line">            append = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (builder.length() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMessageException(<span class="string">"Cannot parse http version from request"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> builder.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> HttpHeaders <span class="title">parseHttpHeaders</span><span class="params">(DynamicByteBuffer src, </span></span></span><br><span class="line"><span class="function"><span class="params">                                            <span class="keyword">int</span> startIndex, <span class="keyword">int</span> endIndex)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * message-header = field-name ":" [ field-value ]</span></span><br><span class="line"><span class="comment">     * field-name     = token</span></span><br><span class="line"><span class="comment">     * field-value    = *( field-content | LWS )</span></span><br><span class="line"><span class="comment">     * field-content  = &lt;the OCTETs making up the field-value</span></span><br><span class="line"><span class="comment">     *                  and consisting of either *TEXT or combinations</span></span><br><span class="line"><span class="comment">     *                  of token, separators, and quoted-string&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> StringBuilder fieldNameBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> HttpHeaders result = <span class="keyword">new</span> HttpHeaders();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = startIndex; i &lt; endIndex; ) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> nextEndOfLine = findNextEndOfLine(src, i);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = i; j &lt; nextEndOfLine; j++) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">byte</span> c = src.get(j);</span><br><span class="line">            <span class="keyword">if</span> (c == <span class="string">':'</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> String fieldName = fieldNameBuilder.toString();</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> valueLength = nextEndOfLine - j - <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">byte</span>[] fieldValue = src.get(j + <span class="number">1</span>, valueLength);</span><br><span class="line">                result.put(fieldName, fieldValue);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                fieldNameBuilder.appendCodePoint(c);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        fieldNameBuilder.setLength(<span class="number">0</span>);</span><br><span class="line">        i = nextEndOfLine;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> HttpRequest <span class="title">createNewRequest</span><span class="params">(HttpMethod method,</span></span></span><br><span class="line"><span class="function"><span class="params">                                            String requestUri,</span></span></span><br><span class="line"><span class="function"><span class="params">                                            String version,</span></span></span><br><span class="line"><span class="function"><span class="params">                                            HttpHeaders headers,</span></span></span><br><span class="line"><span class="function"><span class="params">                                            <span class="keyword">byte</span>[] body)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// converts the absolute url to a relative url </span></span><br><span class="line">    <span class="comment">// with an additional Host header</span></span><br><span class="line">    <span class="keyword">if</span> (requestUri.matches(<span class="string">"^.+?://[^/]+/.*$"</span>)) &#123;</span><br><span class="line">        <span class="keyword">final</span> String mayBeHost = requestUri.replaceAll(<span class="string">"^.+?://([^/]+)/.*$"</span>, <span class="string">"$1"</span>);</span><br><span class="line">        requestUri = requestUri.replaceAll(<span class="string">"^.+?://[^/]+(/.*)$"</span>, <span class="string">"$1"</span>);</span><br><span class="line">        <span class="keyword">if</span> (!headers.containsName(HEADER_HOST)) &#123;</span><br><span class="line">            headers.put(HEADER_HOST, mayBeHost.getBytes());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> HttpRequest(method, requestUri, version, headers, body);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Generates-Bytes-of-HttpResponse"><a href="#Generates-Bytes-of-HttpResponse" class="headerlink" title="Generates Bytes of HttpResponse"></a>Generates Bytes of <code>HttpResponse</code></h2><p>Interact with channels of <code>java.nio</code>, we need to send back bytes. With an <code>HttpResponse</code> being generating, we have to find some approaches to convert responses to bytes. We will do these jobs by the aid of <code>DynamicByteBuffer</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] BYTES_SPACE = <span class="string">" "</span>.getBytes();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] BYTES_CRLF = <span class="string">"\r\n"</span>.getBytes();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] BYTES_COLON = <span class="string">":"</span>.getBytes();</span><br><span class="line"></span><br><span class="line"><span class="meta">@Nonnull</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">byte</span>[] toBytes(<span class="meta">@Nonnull</span> HttpResponse response) &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Http Response Structure:</span></span><br><span class="line"><span class="comment">     * Response = Status-Line</span></span><br><span class="line"><span class="comment">     *            *(( general-header</span></span><br><span class="line"><span class="comment">     *              | response-header</span></span><br><span class="line"><span class="comment">     *              | entity-header ) CRLF)  ; message-headers</span></span><br><span class="line"><span class="comment">     *             CRLF</span></span><br><span class="line"><span class="comment">     *             [ message-body ]</span></span><br><span class="line"><span class="comment">     * See Also: https://tools.ietf.org/html/rfc2616</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> var buffer = <span class="keyword">new</span> DynamicByteBuffer();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Status-Line</span></span><br><span class="line">    appendStatusLine(buffer, response);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// message-headers</span></span><br><span class="line">    appendHeaders(buffer, response);</span><br><span class="line">    buffer.append(BYTES_CRLF);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// message-body</span></span><br><span class="line">    buffer.append(response.body());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> buffer.toByteArray();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> appendStatusLine</span><br><span class="line">    (DynamicByteBuffer dst, HttpResponse response) &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Status-Line:</span></span><br><span class="line"><span class="comment">     *  Status-Line = HTTP-Version SP Status-Code SP Reason-Phrase CRLF</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    dst.append((<span class="string">"HTTP/"</span> + response.version()).getBytes());</span><br><span class="line">    dst.append(BYTES_SPACE);</span><br><span class="line">    <span class="keyword">final</span> var status = response.status();</span><br><span class="line">    <span class="keyword">final</span> var statusCodeStr = Integer.toString(status.getStatusCode());</span><br><span class="line">    dst.append(statusCodeStr.getBytes());</span><br><span class="line">    dst.append(BYTES_SPACE);</span><br><span class="line">    dst.append(status.getReasonPhrase().getBytes());</span><br><span class="line">    dst.append(BYTES_CRLF);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">appendHeaders</span><span class="params">(DynamicByteBuffer dst, HttpResponse response)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> var headers = response.headers();</span><br><span class="line">    <span class="keyword">for</span> (String fieldName : headers.getAllNames()) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">byte</span>[] value : headers.getValues(fieldName)) &#123;</span><br><span class="line">            dst.append(fieldName.getBytes());</span><br><span class="line">            dst.append(BYTES_COLON);</span><br><span class="line">            dst.append(BYTES_SPACE);</span><br><span class="line">            dst.append(value);</span><br><span class="line">            dst.append(BYTES_CRLF);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Building an array of bytes out of <code>HttpResponse</code> is as simple as building a <code>String</code> with <code>StringBuilder</code>. What we need to care about is not to forget putting an extra empty line between headers and body.</p>
<p>That’s it for our request parsing and response bytes generating. We will write a method that converts <code>HttpRequest</code> to <code>HttpResponse</code>.</p>
<h2 id="Converts-HttpRequest-to-HttpResponse"><a href="#Converts-HttpRequest-to-HttpResponse" class="headerlink" title="Converts HttpRequest to HttpResponse"></a>Converts <code>HttpRequest</code> to <code>HttpResponse</code></h2><p>For <code>HttpResponse</code> generating, we will create a new class called <code>HttpProtocolObjectProcessor</code>. It implements an interface called <code>ProtocolObjectProcessor</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ProtocolObjectProcessor</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Nonnull</span></span><br><span class="line">    <span class="function">Object <span class="title">process</span><span class="params">(@Nonnull Object object)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>The Server part will call the method on the interface, but it is not its responsibility to create the processor. We will provide a <code>ProtocolFactory</code> instance to the Server. More details will be discussed in the next part.<br>For now, let’s implement methods of <code>HttpProtocolObjectProcessor</code>. Our processor need to find files on the disk based on request uri of <code>HttpRequest</code> in order to generating <code>HttpResponse</code>.<br>The following code snippet shows the method that find files:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Set&lt;String&gt; DEFAULT_WELCOME_FILES = </span><br><span class="line">    Set.of(<span class="string">"index.html"</span>, <span class="string">"index.htm"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Path <span class="title">getLocalFilePath</span><span class="params">(String requestUri)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String relativePath = requestUri.charAt(<span class="number">0</span>) == <span class="string">'/'</span> ? </span><br><span class="line">        requestUri.substring(<span class="number">1</span>) : requestUri;</span><br><span class="line">    <span class="keyword">final</span> Path path = config.getServerRootDirectory()</span><br><span class="line">        .resolve(relativePath);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (Files.isDirectory(path)) &#123;</span><br><span class="line">        <span class="keyword">for</span> (String fileName : DEFAULT_WELCOME_FILES) &#123;</span><br><span class="line">            <span class="keyword">final</span> Path newPath = path.resolve(fileName);</span><br><span class="line">            <span class="keyword">if</span> (Files.exists(newPath)) &#123;</span><br><span class="line">                <span class="keyword">return</span> newPath;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Files.exists(path) ? path : <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>We can see through that we will return a welcome file if path resolved by given request uri points to a directory. Besides, we will return <code>null</code> if the file resolved doesn’t exist in order to notify caller.</p>
<p>Next, let’s implement the method <code>process</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ALLOWED_HTTP_METHODS = <span class="string">"OPTIONS, GET, HEAD"</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Set&lt;String&gt; TEXT_FILE_MIMETYPES =</span><br><span class="line">        Set.of(<span class="string">"text/css"</span>, <span class="string">"text/html"</span>, <span class="string">"text/javascript"</span>,</span><br><span class="line">               <span class="string">"application/javascript"</span>, <span class="string">"text/plain"</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] EMPTY_BYTE_ARRAY = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line"><span class="meta">@Nonnull</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">process</span><span class="params">(@Nonnull Object object)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (object <span class="keyword">instanceof</span> HttpRequest) &#123;</span><br><span class="line">        <span class="keyword">final</span> var request = (HttpRequest) object;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> String version = request.version();</span><br><span class="line">        HttpStatus status;</span><br><span class="line">        <span class="keyword">final</span> var headers = <span class="keyword">new</span> HttpHeaders();</span><br><span class="line">        <span class="keyword">byte</span>[] body;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (request.method()) &#123;</span><br><span class="line">            <span class="keyword">case</span> GET: &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">final</span> Path filePath = </span><br><span class="line">                        getLocalFilePath(request.requestUri());</span><br><span class="line">                    <span class="keyword">if</span> (filePath == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        status = HttpStatus.NOT_FOUND;</span><br><span class="line">                        body = EMPTY_BYTE_ARRAY;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            status = HttpStatus.OK;</span><br><span class="line">                            body = Files.readAllBytes(filePath);</span><br><span class="line">                            putGETHeaders(headers, filePath, <span class="keyword">true</span>);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                            logFileProcessIOException(e, filePath);</span><br><span class="line">                            body = EMPTY_BYTE_ARRAY;</span><br><span class="line">                            status = HttpStatus.INTERNAL_SERVER_ERROR;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InvalidPathException e) &#123;</span><br><span class="line">                    status = HttpStatus.BAD_REQUEST;</span><br><span class="line">                    body = EMPTY_BYTE_ARRAY;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> HEAD: &#123;</span><br><span class="line">                body = EMPTY_BYTE_ARRAY;</span><br><span class="line">                <span class="keyword">final</span> Path filePath = getLocalFilePath(request.requestUri());</span><br><span class="line">                <span class="keyword">if</span> (filePath == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    status = HttpStatus.NOT_FOUND;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        status = HttpStatus.OK;</span><br><span class="line">                        putGETHeaders(headers, filePath, <span class="keyword">false</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        logFileProcessIOException(e, filePath);</span><br><span class="line">                        status = HttpStatus.INTERNAL_SERVER_ERROR;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> OPTIONS: &#123;</span><br><span class="line">                status = HttpStatus.OK;</span><br><span class="line">                body = EMPTY_BYTE_ARRAY;</span><br><span class="line">                headers.put(HEADER_ALLOW, ALLOWED_HTTP_METHODS.getBytes());</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">default</span>: &#123;</span><br><span class="line">                status = HttpStatus.METHOD_NOT_ALLOWED;</span><br><span class="line">                body = EMPTY_BYTE_ARRAY;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        putCommonHeaders(headers);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HttpResponse(version, status, headers, body);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">putGETHeaders</span><span class="params">(HttpHeaders headers, Path filePath, </span></span></span><br><span class="line"><span class="function"><span class="params">                           <span class="keyword">boolean</span> withContentLength)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (withContentLength) &#123;</span><br><span class="line">        <span class="keyword">final</span> String contentLength = Long.toString(Files.size(filePath));</span><br><span class="line">        headers.put(HEADER_CONTENT_LENGTH, contentLength.getBytes());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String contentType = Files.probeContentType(filePath);</span><br><span class="line">    <span class="keyword">if</span> (contentType != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (TEXT_FILE_MIMETYPES.contains(contentType)) &#123;</span><br><span class="line">            contentType += <span class="string">"; charset="</span> + config.getServerDefaultCharset();</span><br><span class="line">        &#125;</span><br><span class="line">        headers.put(HEADER_CONTENT_TYPE, contentType.getBytes());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">putCommonHeaders</span><span class="params">(HttpHeaders headers)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> var serverDate = getServerDateString();</span><br><span class="line">    headers.put(HEADER_DATE, serverDate.getBytes());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> var serverName = config.getServerName();</span><br><span class="line">    headers.put(HEADER_SERVER, serverName.getBytes());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!headers.containsName(HEADER_CONTENT_LENGTH)) &#123;</span><br><span class="line">        headers.put(HEADER_CONTENT_LENGTH, <span class="string">"0"</span>.getBytes());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>As we have said, we only care about <code>GET</code>, <code>HEAD</code> and <code>OPTIONS</code>. Bytes are read by <code>Files.readAllBytes</code>, while mimetypes are detected by <code>Files.probeContentType</code>. Header <code>Content-Length</code> will either be <code>0</code> or the length of file and header <code>Date</code> is generated by <code>DateTimeFormatter.RFC_1123_DATE_TIME</code> of JSR-310.</p>
<h2 id="To-be-continues…"><a href="#To-be-continues…" class="headerlink" title="To be continues…"></a>To be continues…</h2><p>In this part, we have learnt how to write code to parse, convert,  and generate HTTP messages. In the next part, we will have a look at the classes of Protocol Processor part of our NIO Server.</p>
<hr style="margin-bottom: 20px; margin-top: 35px"> <img alt="Creative Commons License" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png"><br> <b style="color: #2bbc8a">This original article is licensed under a <a target="_blank" href="http://creativecommons.org/licenses/by-sa/4.0/"> Creative Commons Attribution 4.0 International License</a>.</b><br><br> <b style="color: #2bbc8a">Title: </b>Build an NIO HTTP Server, Part 3 Requests and Responses<br> <b style="color: #2bbc8a">Permalink: </b><a href="https://blog.kumasuke.app/2018/07/22/build-an-nio-http-server-3-requests-and-responses/" target="_blank">https://blog.kumasuke.app/2018/07/22/build-an-nio-http-server-3-requests-and-responses/</a>
  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Meet-with-HttpRequest-and-HttpResponse"><span class="toc-number">1.</span> <span class="toc-text">Meet with HttpRequest and HttpResponse</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pinpoint-the-endpoint-of-a-raw-HTTP-Request"><span class="toc-number">2.</span> <span class="toc-text">Pinpoint the endpoint of a raw HTTP Request</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Parse-raw-messages-to-HttpRequest"><span class="toc-number">3.</span> <span class="toc-text">Parse raw messages to HttpRequest</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Generates-Bytes-of-HttpResponse"><span class="toc-number">4.</span> <span class="toc-text">Generates Bytes of HttpResponse</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Converts-HttpRequest-to-HttpResponse"><span class="toc-number">5.</span> <span class="toc-text">Converts HttpRequest to HttpResponse</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#To-be-continues…"><span class="toc-number">6.</span> <span class="toc-text">To be continues…</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://blog.kumasuke.app/2018/07/22/build-an-nio-http-server-3-requests-and-responses/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://blog.kumasuke.app/2018/07/22/build-an-nio-http-server-3-requests-and-responses/&text=Build an NIO HTTP Server, Part 3 Requests and Responses"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://blog.kumasuke.app/2018/07/22/build-an-nio-http-server-3-requests-and-responses/&title=Build an NIO HTTP Server, Part 3 Requests and Responses"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://blog.kumasuke.app/2018/07/22/build-an-nio-http-server-3-requests-and-responses/&is_video=false&description=Build an NIO HTTP Server, Part 3 Requests and Responses"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Build an NIO HTTP Server, Part 3 Requests and Responses&body=Check out this article: https://blog.kumasuke.app/2018/07/22/build-an-nio-http-server-3-requests-and-responses/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://blog.kumasuke.app/2018/07/22/build-an-nio-http-server-3-requests-and-responses/&title=Build an NIO HTTP Server, Part 3 Requests and Responses"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://blog.kumasuke.app/2018/07/22/build-an-nio-http-server-3-requests-and-responses/&title=Build an NIO HTTP Server, Part 3 Requests and Responses"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://blog.kumasuke.app/2018/07/22/build-an-nio-http-server-3-requests-and-responses/&title=Build an NIO HTTP Server, Part 3 Requests and Responses"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://blog.kumasuke.app/2018/07/22/build-an-nio-http-server-3-requests-and-responses/&title=Build an NIO HTTP Server, Part 3 Requests and Responses"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://blog.kumasuke.app/2018/07/22/build-an-nio-http-server-3-requests-and-responses/&name=Build an NIO HTTP Server, Part 3 Requests and Responses&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2019 Kumasuke
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/fontawesome-all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'kumasuke-blog';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


