<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="Disclaimer: Although all articles of this series and all related codes are original, the basic idea of the nio server was taking this project on GitHub as a reference.   This is not the first article">
<meta name="keywords" content="Java,Non-blocking IO,HTTP Protocol,Build an NIO HTTP Server">
<meta property="og:type" content="article">
<meta property="og:title" content="Build an NIO HTTP Server, Part 4 Protocol Processor">
<meta property="og:url" content="https://blog.kumasuke.app/2018/08/10/build-an-nio-http-server-4-protocol-processor/index.html">
<meta property="og:site_name" content="Kumasuke&#39;s Blog">
<meta property="og:description" content="Disclaimer: Although all articles of this series and all related codes are original, the basic idea of the nio server was taking this project on GitHub as a reference.   This is not the first article">
<meta property="og:locale" content="en-US">
<meta property="og:image" content="https://i.creativecommons.org/l/by-sa/4.0/88x31.png">
<meta property="og:updated_time" content="2018-10-24T15:46:18.153Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Build an NIO HTTP Server, Part 4 Protocol Processor">
<meta name="twitter:description" content="Disclaimer: Although all articles of this series and all related codes are original, the basic idea of the nio server was taking this project on GitHub as a reference.   This is not the first article">
<meta name="twitter:image" content="https://i.creativecommons.org/l/by-sa/4.0/88x31.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Build an NIO HTTP Server, Part 4 Protocol Processor</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2018/09/19/build-an-nio-http-server-5-server/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2018/07/22/build-an-nio-http-server-3-requests-and-responses/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://blog.kumasuke.app/2018/08/10/build-an-nio-http-server-4-protocol-processor/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://blog.kumasuke.app/2018/08/10/build-an-nio-http-server-4-protocol-processor/&text=Build an NIO HTTP Server, Part 4 Protocol Processor"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://blog.kumasuke.app/2018/08/10/build-an-nio-http-server-4-protocol-processor/&title=Build an NIO HTTP Server, Part 4 Protocol Processor"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://blog.kumasuke.app/2018/08/10/build-an-nio-http-server-4-protocol-processor/&is_video=false&description=Build an NIO HTTP Server, Part 4 Protocol Processor"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Build an NIO HTTP Server, Part 4 Protocol Processor&body=Check out this article: https://blog.kumasuke.app/2018/08/10/build-an-nio-http-server-4-protocol-processor/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://blog.kumasuke.app/2018/08/10/build-an-nio-http-server-4-protocol-processor/&title=Build an NIO HTTP Server, Part 4 Protocol Processor"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://blog.kumasuke.app/2018/08/10/build-an-nio-http-server-4-protocol-processor/&title=Build an NIO HTTP Server, Part 4 Protocol Processor"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://blog.kumasuke.app/2018/08/10/build-an-nio-http-server-4-protocol-processor/&title=Build an NIO HTTP Server, Part 4 Protocol Processor"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://blog.kumasuke.app/2018/08/10/build-an-nio-http-server-4-protocol-processor/&title=Build an NIO HTTP Server, Part 4 Protocol Processor"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://blog.kumasuke.app/2018/08/10/build-an-nio-http-server-4-protocol-processor/&name=Build an NIO HTTP Server, Part 4 Protocol Processor&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Meet-with-interfaces-again"><span class="toc-number">1.</span> <span class="toc-text">Meet with interfaces again</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ConnectionReader"><span class="toc-number">1.1.</span> <span class="toc-text">ConnectionReader</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ConnectionWriter"><span class="toc-number">1.2.</span> <span class="toc-text">ConnectionWriter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ProtocolObjectProcessor"><span class="toc-number">1.3.</span> <span class="toc-text">ProtocolObjectProcessor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ProtocolFactory"><span class="toc-number">1.4.</span> <span class="toc-text">ProtocolFactory</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Basic-implementations-of-interfaces"><span class="toc-number">2.</span> <span class="toc-text">Basic implementations of interfaces</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#AbstractConnectionReader-lt-T-gt"><span class="toc-number">2.1.</span> <span class="toc-text">AbstractConnectionReader&lt;T&gt;</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AbstractConnectionWriter-lt-T-gt"><span class="toc-number">2.2.</span> <span class="toc-text">AbstractConnectionWriter&lt;T&gt;</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AbstractProtocolObjectProcessor"><span class="toc-number">2.3.</span> <span class="toc-text">AbstractProtocolObjectProcessor</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Implementations-for-HTTP-Protocol"><span class="toc-number">3.</span> <span class="toc-text">Implementations for HTTP Protocol</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#HttpConnectionReader"><span class="toc-number">3.1.</span> <span class="toc-text">HttpConnectionReader</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HttpConnectionWriter"><span class="toc-number">3.2.</span> <span class="toc-text">HttpConnectionWriter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HttpProtocolObjectProcessor"><span class="toc-number">3.3.</span> <span class="toc-text">HttpProtocolObjectProcessor</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#To-be-continued…"><span class="toc-number">4.</span> <span class="toc-text">To be continued…</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Build an NIO HTTP Server, Part 4 Protocol Processor
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Kumasuke's Blog</span>
      </span>
      
    <div class="postdate">
        <time datetime="2018-08-10T14:03:56.000Z" itemprop="datePublished">2018-08-10</time>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/Build-an-NIO-HTTP-Server/">Build an NIO HTTP Server</a>, <a class="tag-link" href="/tags/HTTP-Protocol/">HTTP Protocol</a>, <a class="tag-link" href="/tags/Java/">Java</a>, <a class="tag-link" href="/tags/Non-blocking-IO/">Non-blocking IO</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <blockquote>
<p><em>Disclaimer</em>: Although all articles of this series and all related codes are original, the basic idea of the nio server was taking <a href="https://github.com/jjenkov/java-nio-server/tree/master/src/main/java/com/jenkov/nioserver" target="_blank" rel="noopener">this project</a> on GitHub as a reference.</p>
</blockquote>
<blockquote>
<p>This is not the first article of <a href="https://blog.kumasuke.app/tags/Build-an-NIO-HTTP-Server/">this series</a>, click <a href="https://blog.kumasuke.app/2018/07/12/build-an-nio-http-server-0-prerequisite/">here</a> to see the first article of this series.</p>
</blockquote>
<p>After finishing the implementation of HTTP parser, let us integrate it with the Protocol Processor part of our NIO Server.</p>
<p>First, let me introduce a few significant interfaces in the Protocol Processor part.</p>
<h2 id="Meet-with-interfaces-again"><a href="#Meet-with-interfaces-again" class="headerlink" title="Meet with interfaces again"></a>Meet with interfaces again</h2><p>There are three main component interfaces and one factory in the Protocol Processor part. As we have introduced in part 1, that is <code>ConnectionReader</code>, <code>ConnectionWriter</code>, <code>ProtocolObjectProcessor</code> and <code>ProtocolFactory</code>.</p>
<p>Before taking a look at <code>ConnectionReader</code> and <code>ConnectionWriter</code>, let’s have a glance at the class called <code>Connection</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Connection</span> <span class="keyword">implements</span> <span class="title">Closeable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> id;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SocketChannel socketChannel;</span><br><span class="line"></span><br><span class="line">    Connection(<span class="keyword">long</span> id,</span><br><span class="line">               <span class="meta">@Nonnull</span> SocketChannel socketChannel) &#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.socketChannel = socketChannel;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">id</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nonnull</span></span><br><span class="line">    <span class="function">SocketChannel <span class="title">socketChannel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> socketChannel;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        socketChannel.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// omits equals() and hashCode()...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="ConnectionReader"><a href="#ConnectionReader" class="headerlink" title="ConnectionReader"></a><code>ConnectionReader</code></h3><p>Let’s see the definition of <code>ConnectionReader</code> first:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ConnectionReader</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">read</span><span class="params">(@Nonnull Connection connection)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function">Object <span class="title">next</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>There are three methods in the aforementioned interface:</p>
<ul>
<li><code>read</code>: reads bytes from the given <code>Connection</code>, and then the <code>ConnectionReader</code> should convert raw bytes to easy-to-process objects. For example, we could convert given raw bytes to the instances of <code>HttpRequest</code>;</li>
<li><code>hasNext</code>: tests if there is any generated object (e.g. an <code>HttpRequest</code> object);</li>
<li><code>next</code>: get next generated object. We could return <code>null</code> or throw an exception when there is not any object could be returned.</li>
</ul>
<h3 id="ConnectionWriter"><a href="#ConnectionWriter" class="headerlink" title="ConnectionWriter"></a><code>ConnectionWriter</code></h3><p>We also have an interface called <code>ConnectionWriter</code> to perform write-related operations:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ConnectionWriter</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">write</span><span class="params">(@Nonnull Connection connection)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(@Nonnull Object object)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>There are two methods declared in the interface above:</p>
<ul>
<li><code>write</code>: this method writes added objects to the given <code>Connection</code>. Before writing to the <code>Connection</code>, we should convert the objects to bytes;</li>
<li><code>add</code>: adds the object to the writing list, preparing to be written.</li>
</ul>
<h3 id="ProtocolObjectProcessor"><a href="#ProtocolObjectProcessor" class="headerlink" title="ProtocolObjectProcessor"></a><code>ProtocolObjectProcessor</code></h3><p><code>ProtocolObjectProcessor</code> is an interface that connects <code>ConnectionReader</code> and <code>ConnectionWriter</code>, it converts object that gets from <code>ConnectionReader</code> to the objects that the <code>ConnectionWriter</code> needs:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ProtocolObjectProcessor</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Nonnull</span></span><br><span class="line">    <span class="function">Object <span class="title">process</span><span class="params">(@Nonnull Object object)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>The only method <code>process</code> performs the conversion whe have mentioned. For instance, we will write an <code>HttpProtocolObjectProcessor</code> that converts <code>HttpRequest</code>s to <code>HttpResponse</code>.</p>
<h3 id="ProtocolFactory"><a href="#ProtocolFactory" class="headerlink" title="ProtocolFactory"></a><code>ProtocolFactory</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ProtocolFactory</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Nonnull</span></span><br><span class="line">    <span class="function">ConnectionReader <span class="title">newConnectionReader</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nonnull</span></span><br><span class="line">    <span class="function">ConnectionWriter <span class="title">newConnectionWriter</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nonnull</span></span><br><span class="line">    <span class="function">ProtocolObjectProcessor <span class="title">newProtocolObjectProcessor</span><span class="params">(@Nonnull Config config)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ProtocolFactory</code> is a simple factory that creates instances of all three interfaces we have talked. It contains all interfaces we need when we need to support a protocol.</p>
<h2 id="Basic-implementations-of-interfaces"><a href="#Basic-implementations-of-interfaces" class="headerlink" title="Basic implementations of interfaces"></a>Basic implementations of interfaces</h2><h3 id="AbstractConnectionReader-lt-T-gt"><a href="#AbstractConnectionReader-lt-T-gt" class="headerlink" title="AbstractConnectionReader&lt;T&gt;"></a><code>AbstractConnectionReader&lt;T&gt;</code></h3><p><code>AbstractConnectionReader&lt;T&gt;</code> is a basic implementation of <code>ConnectionReader</code>, it contains common methods for <code>ConnectionReader</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractConnectionReader</span>&lt;<span class="title">T</span>&gt; </span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">ConnectionReader</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = </span><br><span class="line">        LoggerFactory.getLogger(ConnectionReader.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> END_OF_STREAM = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BUFFER_SIZE = <span class="number">2048</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Queue&lt;T&gt; objects = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ByteBuffer buffer = ByteBuffer.allocate(BUFFER_SIZE);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">(@Nonnull Connection connection, </span></span></span><br><span class="line"><span class="function"><span class="params">                             @Nonnull DynamicByteBuffer dstBuffer)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        buffer.clear();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> totalBytesRead = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> nBytesRead;</span><br><span class="line">        <span class="keyword">while</span> ((nBytesRead = connection.socketChannel().read(buffer)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            buffer.flip();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> nRemainingBytes = buffer.remaining();</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">byte</span>[] tmp = <span class="keyword">new</span> <span class="keyword">byte</span>[nRemainingBytes];</span><br><span class="line">            buffer.get(tmp);</span><br><span class="line">            dstBuffer.append(tmp);</span><br><span class="line"></span><br><span class="line">            buffer.compact();</span><br><span class="line">            totalBytesRead += nBytesRead;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nBytesRead == END_OF_STREAM) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> EndOfStreamException();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> totalBytesRead;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> !objects.isEmpty();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> objects.poll();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchElementException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Basically, we provide a method call <code>read</code> which takes a <code>Connection</code> and a <code>DynamicByteBuffer</code>. It read bytes until exhausted from <code>Connection</code> and save these bytes to <code>DynamicByteBuffer</code>. What the method returns is the number of bytes read during this time of invoke.</p>
<h3 id="AbstractConnectionWriter-lt-T-gt"><a href="#AbstractConnectionWriter-lt-T-gt" class="headerlink" title="AbstractConnectionWriter&lt;T&gt;"></a><code>AbstractConnectionWriter&lt;T&gt;</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractConnectionWriter</span>&lt;<span class="title">T</span>&gt; </span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">ConnectionWriter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = </span><br><span class="line">        LoggerFactory.getLogger(ConnectionWriter.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BUFFER_SIZE = <span class="number">2048</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Queue&lt;T&gt; objects = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ByteBuffer buffer = ByteBuffer.allocate(BUFFER_SIZE);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">write</span><span class="params">((@Nonnull DynamicByteBuffer srcBuffer, </span></span></span><br><span class="line"><span class="function"><span class="params">                               @Nonnull Connection connection)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        buffer.clear();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> getLength = BUFFER_SIZE &gt; srcBuffer.length() ? </span><br><span class="line">            srcBuffer.length() : BUFFER_SIZE;</span><br><span class="line">        <span class="keyword">if</span> (getLength != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">byte</span>[] bytes = srcBuffer.get(<span class="number">0</span>, getLength);</span><br><span class="line">            buffer.put(bytes);</span><br><span class="line">            buffer.flip();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> totalBytesWrite = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">int</span> nBytesWrite;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                nBytesWrite = connection.socketChannel().write(buffer);</span><br><span class="line">                totalBytesWrite += nBytesWrite;</span><br><span class="line">            &#125; <span class="keyword">while</span> (nBytesWrite != <span class="number">0</span> &amp;&amp; buffer.hasRemaining());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// totalBytesWrite may smaller than or equal to getLength,</span></span><br><span class="line">            <span class="comment">// only pops with then length that actually writes</span></span><br><span class="line">            <span class="keyword">if</span> (totalBytesWrite != <span class="number">0</span>) &#123;</span><br><span class="line">                srcBuffer.pop(totalBytesWrite);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> totalBytesWrite;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> T <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> objects.poll();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchElementException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Same as the one for <code>ConnectionReader</code>, we also provide a basic method for <code>ConnectionWriter</code> called <code>write</code>. The method takes a <code>DynamicByteBuffer</code> and a <code>Connection</code> and it writes bytes in the <code>DynamicByteBuffer</code> to the <code>Connection</code>. The method also returns the number of bytes written.</p>
<h3 id="AbstractProtocolObjectProcessor"><a href="#AbstractProtocolObjectProcessor" class="headerlink" title="AbstractProtocolObjectProcessor"></a><code>AbstractProtocolObjectProcessor</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractProtocolObjectProcessor</span> </span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">ProtocolObjectProcessor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = </span><br><span class="line">        LoggerFactory.getLogger(ProtocolObjectProcessor.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Config config;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">AbstractProtocolObjectProcessor</span><span class="params">(@Nonnull Config config)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.config = config;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>AbstractProtocolObjectProcessor</code> is quite trivial. It just has a constructor that takes a <code>Config</code>. We would use the <code>Config</code> to get the settings we need.</p>
<p>After seeing the basic implementations of the three interfaces, let’s take a look at how we support the HTTP protocol we need.</p>
<h2 id="Implementations-for-HTTP-Protocol"><a href="#Implementations-for-HTTP-Protocol" class="headerlink" title="Implementations for HTTP Protocol"></a>Implementations for HTTP Protocol</h2><h3 id="HttpConnectionReader"><a href="#HttpConnectionReader" class="headerlink" title="HttpConnectionReader"></a><code>HttpConnectionReader</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpConnectionReader</span> </span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">AbstractConnectionReader</span>&lt;<span class="title">HttpRequest</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DynamicByteBuffer readBuffer = <span class="keyword">new</span> DynamicByteBuffer();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">(@Nonnull Connection connection)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> nBytesRead = read(connection, readBuffer);</span><br><span class="line">        <span class="keyword">if</span> (nBytesRead &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> endOfRequest = </span><br><span class="line">                HttpSupport.findNextEndOfRequest(readBuffer);</span><br><span class="line">            <span class="keyword">if</span> (endOfRequest != POSITION_NOT_FOUND) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">byte</span>[] tmp = readBuffer.pop(endOfRequest);</span><br><span class="line">                <span class="keyword">final</span> var httpRequest = </span><br><span class="line">                    HttpSupport.parseRequest(<span class="keyword">new</span> DynamicByteBuffer(tmp));</span><br><span class="line"></span><br><span class="line">                logger.info(<span class="string">"Connection#&#123;&#125; request enqueued: "</span> + </span><br><span class="line">                            <span class="string">"method = &#123;&#125;, requestUri = &#123;&#125;"</span>,</span><br><span class="line">                             connection.id(), </span><br><span class="line">                             httpRequest.method(), </span><br><span class="line">                             httpRequest.requestUri());</span><br><span class="line">                objects.add(httpRequest);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> nBytesRead;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nonnull</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HttpRequest <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> HttpRequest first = <span class="keyword">super</span>.next();</span><br><span class="line">        <span class="keyword">if</span> (first != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> first;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchElementException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The <code>HttpConnectionReader</code> is quite trivial. It reads bytes from <code>Connection</code> and uses methods in <code>HttpSupport</code> to detect if there is any full HTTP Request. If there is a full request, we added it to the list for later use.</p>
<h3 id="HttpConnectionWriter"><a href="#HttpConnectionWriter" class="headerlink" title="HttpConnectionWriter"></a><code>HttpConnectionWriter</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpConnectionWriter</span> </span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">AbstractConnectionWriter</span>&lt;<span class="title">HttpResponse</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DynamicByteBuffer writeBuffer = <span class="keyword">new</span> DynamicByteBuffer();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">write</span><span class="params">(@Nonnull Connection connection)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        HttpResponse response;</span><br><span class="line">        <span class="keyword">while</span> ((response = next()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">byte</span>[] bytes = HttpSupport.toBytes(response);</span><br><span class="line">            writeBuffer.append(bytes);</span><br><span class="line"></span><br><span class="line">            logger.info(<span class="string">"Connection#&#123;&#125; response enqueued: "</span> + </span><br><span class="line">                        <span class="string">"statusCode = &#123;&#125;, statusText = &#123;&#125;"</span>,</span><br><span class="line">                        connection.id(), </span><br><span class="line">                        response.status().getStatusCode(), </span><br><span class="line">                        response.status().getReasonPhrase());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> write(writeBuffer, connection);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(@Nonnull Object object)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (object <span class="keyword">instanceof</span> HttpResponse) &#123;</span><br><span class="line">            <span class="keyword">final</span> var response = (HttpResponse) object;</span><br><span class="line">            objects.add(response);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The <code>HttpConnectionWriter</code> is much simpler class than <code>HttpConnectionReader</code>. It just writes bytes in the buffer until the buffer is empty.</p>
<h3 id="HttpProtocolObjectProcessor"><a href="#HttpProtocolObjectProcessor" class="headerlink" title="HttpProtocolObjectProcessor"></a><code>HttpProtocolObjectProcessor</code></h3><p>The most important part of our protocol support must be the <code>HttpProtocolObjectProcessor</code>, let’s take a look at its code:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpProtocolObjectProcessor</span> </span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">AbstractProtocolObjectProcessor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ALLOWED_HTTP_METHODS = <span class="string">"OPTIONS, GET, HEAD"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Set&lt;String&gt; DEFAULT_WELCOME_FILES = </span><br><span class="line">        Set.of(<span class="string">"index.html"</span>, <span class="string">"index.htm"</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Set&lt;String&gt; TEXT_FILE_MIMETYPES =</span><br><span class="line">            Set.of(<span class="string">"text/css"</span>, <span class="string">"text/html"</span>, <span class="string">"text/javascript"</span>, </span><br><span class="line">                   <span class="string">"application/javascript"</span>, <span class="string">"text/plain"</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] EMPTY_BYTE_ARRAY = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    HttpProtocolObjectProcessor(<span class="meta">@Nonnull</span> Config config) &#123;</span><br><span class="line">        <span class="keyword">super</span>(config);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nonnull</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">process</span><span class="params">(@Nonnull Object object)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (object <span class="keyword">instanceof</span> HttpRequest) &#123;</span><br><span class="line">            <span class="keyword">final</span> var request = (HttpRequest) object;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> String version = request.version();</span><br><span class="line">            HttpStatus status;</span><br><span class="line">            <span class="keyword">final</span> var headers = <span class="keyword">new</span> HttpHeaders();</span><br><span class="line">            <span class="keyword">byte</span>[] body;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> HttpMethod method = request.method();</span><br><span class="line">            <span class="keyword">switch</span> (request.method()) &#123;</span><br><span class="line">                <span class="keyword">case</span> GET:</span><br><span class="line">                <span class="keyword">case</span> HEAD: &#123;</span><br><span class="line">                    <span class="keyword">final</span> Path filePath;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        filePath = getLocalFilePath(request.requestUri());</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InvalidPathException e) &#123;</span><br><span class="line">                        status = HttpStatus.BAD_REQUEST;</span><br><span class="line">                        body = EMPTY_BYTE_ARRAY;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (filePath == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        status = HttpStatus.NOT_FOUND;</span><br><span class="line">                        body = EMPTY_BYTE_ARRAY;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">final</span> <span class="keyword">boolean</span> needBody = (method == HttpMethod.GET);</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            status = HttpStatus.OK;</span><br><span class="line">                            body = needBody ? Files.readAllBytes(filePath): EMPTY_BYTE_ARRAY;</span><br><span class="line">                            putGETHeaders(headers, filePath, needBody);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                            logFileProcessIOException(e, filePath);</span><br><span class="line">                            body = EMPTY_BYTE_ARRAY;</span><br><span class="line">                            status = HttpStatus.INTERNAL_SERVER_ERROR;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">case</span> OPTIONS: &#123;</span><br><span class="line">                    status = HttpStatus.OK;</span><br><span class="line">                    body = EMPTY_BYTE_ARRAY;</span><br><span class="line">                    headers.put(HEADER_ALLOW, ALLOWED_HTTP_METHODS.getBytes());</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">default</span>: &#123;</span><br><span class="line">                    status = HttpStatus.METHOD_NOT_ALLOWED;</span><br><span class="line">                    body = EMPTY_BYTE_ARRAY;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            putCommonHeaders(headers);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> HttpResponse(version, status, headers, body);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">logFileProcessIOException</span><span class="params">(IOException e, Path filePath)</span> </span>&#123;</span><br><span class="line">        logger.error(<span class="string">"error encountered when reading local file: "</span> +</span><br><span class="line">                     filePath.toString(), e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">putGETHeaders</span><span class="params">(HttpHeaders headers, </span></span></span><br><span class="line"><span class="function"><span class="params">                               Path filePath, </span></span></span><br><span class="line"><span class="function"><span class="params">                               <span class="keyword">boolean</span> withContentLength)</span> </span></span><br><span class="line"><span class="function">                    <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (withContentLength) &#123;</span><br><span class="line">            <span class="keyword">final</span> String contentLength = Long.toString(Files.size(filePath));</span><br><span class="line">            headers.put(HEADER_CONTENT_LENGTH, contentLength.getBytes());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String contentType = Files.probeContentType(filePath);</span><br><span class="line">        <span class="keyword">if</span> (contentType != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (TEXT_FILE_MIMETYPES.contains(contentType)) &#123;</span><br><span class="line">                contentType += <span class="string">"; charset="</span> + config.getServerDefaultCharset();</span><br><span class="line">            &#125;</span><br><span class="line">            headers.put(HEADER_CONTENT_TYPE, contentType.getBytes());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">putCommonHeaders</span><span class="params">(HttpHeaders headers)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> var serverDate = getServerDateString();</span><br><span class="line">        headers.put(HEADER_DATE, serverDate.getBytes());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> var serverName = config.getServerName();</span><br><span class="line">        headers.put(HEADER_SERVER, serverName.getBytes());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!headers.containsName(HEADER_CONTENT_LENGTH)) &#123;</span><br><span class="line">            headers.put(HEADER_CONTENT_LENGTH, <span class="string">"0"</span>.getBytes());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getServerDateString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> DateTimeFormatter.RFC_1123_DATE_TIME</span><br><span class="line">            .format(ZonedDateTime.now(ZoneOffset.UTC));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Path <span class="title">getLocalFilePath</span><span class="params">(String requestUri)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> String relativePath = requestUri.charAt(<span class="number">0</span>) == <span class="string">'/'</span> ? </span><br><span class="line">            requestUri.substring(<span class="number">1</span>) : requestUri;</span><br><span class="line">        <span class="keyword">final</span> Path path = config.getServerRootDirectory()</span><br><span class="line">            .resolve(relativePath);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Files.isDirectory(path)) &#123;</span><br><span class="line">            <span class="keyword">for</span> (String fileName : DEFAULT_WELCOME_FILES) &#123;</span><br><span class="line">                <span class="keyword">final</span> Path newPath = path.resolve(fileName);</span><br><span class="line">                <span class="keyword">if</span> (Files.exists(newPath)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> newPath;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Files.exists(path) ? path : <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>After reading the code, we could understand what the <code>HttpProtocolObjectProcessor</code> does. It reads and extracts the request uri from HTTP Request and find the local file based on config. If we could find the file that is requested, we return its content as response. Otherwise we return suitable HTTP status code.</p>
<p>What left is the <code>HttpProtocolFactory</code>, it just simply creates instances of three interfaces. Considering the length limit, we choose not to show the code of the <code>HttpProtocolFactory</code>.</p>
<h2 id="To-be-continued…"><a href="#To-be-continued…" class="headerlink" title="To be continued…"></a>To be continued…</h2><p>In this article, we shows how the Protocol Processor part goes on. In the next part, let’s have a look at the Server part of our NIO Server.</p>
<hr style="margin-bottom: 20px; margin-top: 35px"> <img alt="Creative Commons License" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png"><br> <b style="color: #2bbc8a">This original article is licensed under a <a target="_blank" href="http://creativecommons.org/licenses/by-sa/4.0/"> Creative Commons Attribution 4.0 International License</a>.</b><br><br> <b style="color: #2bbc8a">Title: </b>Build an NIO HTTP Server, Part 4 Protocol Processor<br> <b style="color: #2bbc8a">Permalink: </b><a href="https://blog.kumasuke.app/2018/08/10/build-an-nio-http-server-4-protocol-processor/" target="_blank">https://blog.kumasuke.app/2018/08/10/build-an-nio-http-server-4-protocol-processor/</a>
  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Meet-with-interfaces-again"><span class="toc-number">1.</span> <span class="toc-text">Meet with interfaces again</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ConnectionReader"><span class="toc-number">1.1.</span> <span class="toc-text">ConnectionReader</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ConnectionWriter"><span class="toc-number">1.2.</span> <span class="toc-text">ConnectionWriter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ProtocolObjectProcessor"><span class="toc-number">1.3.</span> <span class="toc-text">ProtocolObjectProcessor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ProtocolFactory"><span class="toc-number">1.4.</span> <span class="toc-text">ProtocolFactory</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Basic-implementations-of-interfaces"><span class="toc-number">2.</span> <span class="toc-text">Basic implementations of interfaces</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#AbstractConnectionReader-lt-T-gt"><span class="toc-number">2.1.</span> <span class="toc-text">AbstractConnectionReader&lt;T&gt;</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AbstractConnectionWriter-lt-T-gt"><span class="toc-number">2.2.</span> <span class="toc-text">AbstractConnectionWriter&lt;T&gt;</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AbstractProtocolObjectProcessor"><span class="toc-number">2.3.</span> <span class="toc-text">AbstractProtocolObjectProcessor</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Implementations-for-HTTP-Protocol"><span class="toc-number">3.</span> <span class="toc-text">Implementations for HTTP Protocol</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#HttpConnectionReader"><span class="toc-number">3.1.</span> <span class="toc-text">HttpConnectionReader</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HttpConnectionWriter"><span class="toc-number">3.2.</span> <span class="toc-text">HttpConnectionWriter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HttpProtocolObjectProcessor"><span class="toc-number">3.3.</span> <span class="toc-text">HttpProtocolObjectProcessor</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#To-be-continued…"><span class="toc-number">4.</span> <span class="toc-text">To be continued…</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://blog.kumasuke.app/2018/08/10/build-an-nio-http-server-4-protocol-processor/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://blog.kumasuke.app/2018/08/10/build-an-nio-http-server-4-protocol-processor/&text=Build an NIO HTTP Server, Part 4 Protocol Processor"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://blog.kumasuke.app/2018/08/10/build-an-nio-http-server-4-protocol-processor/&title=Build an NIO HTTP Server, Part 4 Protocol Processor"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://blog.kumasuke.app/2018/08/10/build-an-nio-http-server-4-protocol-processor/&is_video=false&description=Build an NIO HTTP Server, Part 4 Protocol Processor"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Build an NIO HTTP Server, Part 4 Protocol Processor&body=Check out this article: https://blog.kumasuke.app/2018/08/10/build-an-nio-http-server-4-protocol-processor/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://blog.kumasuke.app/2018/08/10/build-an-nio-http-server-4-protocol-processor/&title=Build an NIO HTTP Server, Part 4 Protocol Processor"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://blog.kumasuke.app/2018/08/10/build-an-nio-http-server-4-protocol-processor/&title=Build an NIO HTTP Server, Part 4 Protocol Processor"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://blog.kumasuke.app/2018/08/10/build-an-nio-http-server-4-protocol-processor/&title=Build an NIO HTTP Server, Part 4 Protocol Processor"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://blog.kumasuke.app/2018/08/10/build-an-nio-http-server-4-protocol-processor/&title=Build an NIO HTTP Server, Part 4 Protocol Processor"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://blog.kumasuke.app/2018/08/10/build-an-nio-http-server-4-protocol-processor/&name=Build an NIO HTTP Server, Part 4 Protocol Processor&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2019 Kumasuke
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/fontawesome-all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'kumasuke-blog';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


