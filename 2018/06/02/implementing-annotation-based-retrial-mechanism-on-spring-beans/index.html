<!DOCTYPE html>
<html>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="Disclaimer: Although this article is original, the annotation @RetryOnFailure mentioned within this article was inspired by @RetryOnFailure in jcabi-aspects.  In Spring Framework, we may often come a">
<meta name="keywords" content="Java,Spring,Dynamic Proxy,CGLib,RetryOnFailure">
<meta property="og:type" content="article">
<meta property="og:title" content="Implementing annotation-based retrial mechanism on Spring Beans">
<meta property="og:url" content="https://blog.kumasuke.app/2018/06/02/implementing-annotation-based-retrial-mechanism-on-spring-beans/index.html">
<meta property="og:site_name" content="Kumasuke&#39;s Blog">
<meta property="og:description" content="Disclaimer: Although this article is original, the annotation @RetryOnFailure mentioned within this article was inspired by @RetryOnFailure in jcabi-aspects.  In Spring Framework, we may often come a">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://blog.kumasuke.app/img/2018/06/beanpostprocessor-overview.jpg">
<meta property="og:image" content="https://blog.kumasuke.app/img/2018/06/test-say-hello.png">
<meta property="og:image" content="https://blog.kumasuke.app/img/2018/06/test-say-hello-from-foreigners.png">
<meta property="og:updated_time" content="2018-06-02T09:06:17.108Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Implementing annotation-based retrial mechanism on Spring Beans">
<meta name="twitter:description" content="Disclaimer: Although this article is original, the annotation @RetryOnFailure mentioned within this article was inspired by @RetryOnFailure in jcabi-aspects.  In Spring Framework, we may often come a">
<meta name="twitter:image" content="https://blog.kumasuke.app/img/2018/06/beanpostprocessor-overview.jpg">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Implementing annotation-based retrial mechanism on Spring Beans</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" href="/2018/05/25/can-you-write-singleton-pattern-correctly-in-java/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://blog.kumasuke.app/2018/06/02/implementing-annotation-based-retrial-mechanism-on-spring-beans/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://blog.kumasuke.app/2018/06/02/implementing-annotation-based-retrial-mechanism-on-spring-beans/&text=Implementing annotation-based retrial mechanism on Spring Beans"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://blog.kumasuke.app/2018/06/02/implementing-annotation-based-retrial-mechanism-on-spring-beans/&title=Implementing annotation-based retrial mechanism on Spring Beans"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://blog.kumasuke.app/2018/06/02/implementing-annotation-based-retrial-mechanism-on-spring-beans/&is_video=false&description=Implementing annotation-based retrial mechanism on Spring Beans"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Implementing annotation-based retrial mechanism on Spring Beans&body=Check out this article: https://blog.kumasuke.app/2018/06/02/implementing-annotation-based-retrial-mechanism-on-spring-beans/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://blog.kumasuke.app/2018/06/02/implementing-annotation-based-retrial-mechanism-on-spring-beans/&title=Implementing annotation-based retrial mechanism on Spring Beans"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://blog.kumasuke.app/2018/06/02/implementing-annotation-based-retrial-mechanism-on-spring-beans/&title=Implementing annotation-based retrial mechanism on Spring Beans"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://blog.kumasuke.app/2018/06/02/implementing-annotation-based-retrial-mechanism-on-spring-beans/&title=Implementing annotation-based retrial mechanism on Spring Beans"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://blog.kumasuke.app/2018/06/02/implementing-annotation-based-retrial-mechanism-on-spring-beans/&title=Implementing annotation-based retrial mechanism on Spring Beans"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://blog.kumasuke.app/2018/06/02/implementing-annotation-based-retrial-mechanism-on-spring-beans/&name=Implementing annotation-based retrial mechanism on Spring Beans&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Definition-of-RetryOnFailure"><span class="toc-number">1.</span> <span class="toc-text">Definition of @RetryOnFailure</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Meet-with-BeanPostProcessor"><span class="toc-number">2.</span> <span class="toc-text">Meet with BeanPostProcessor</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Enhance-Bean-with-retrial-mechanism"><span class="toc-number">3.</span> <span class="toc-text">Enhance Bean with retrial mechanism</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Detect-interface-based-Bean"><span class="toc-number">3.1.</span> <span class="toc-text">Detect interface-based Bean</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Preparation-to-enhance-Bean"><span class="toc-number">3.2.</span> <span class="toc-text">Preparation to enhance Bean</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Extracts-annotated-methods"><span class="toc-number">3.2.1.</span> <span class="toc-text">Extracts annotated methods</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Helper-classes"><span class="toc-number">3.2.2.</span> <span class="toc-text">Helper classes</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Common-parts-of-both-approaches"><span class="toc-number">3.3.</span> <span class="toc-text">Common parts of both approaches</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Common-implementation-of-both-ways"><span class="toc-number">3.3.1.</span> <span class="toc-text">Common implementation of both ways</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Implement-of-invokeWithRetry"><span class="toc-number">3.3.2.</span> <span class="toc-text">Implement of invokeWithRetry</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Enhance-Bean-with-dynamic-proxy"><span class="toc-number">3.4.</span> <span class="toc-text">Enhance Bean with dynamic proxy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Enhance-Bean-with-CGLib"><span class="toc-number">3.5.</span> <span class="toc-text">Enhance Bean with CGLib</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Try-RetryOnFailure"><span class="toc-number">4.</span> <span class="toc-text">Try @RetryOnFailure</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Use-it-on-a-interfaced-based-Service"><span class="toc-number">4.1.</span> <span class="toc-text">Use it on a interfaced-based @Service</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Use-it-on-simple-Bean"><span class="toc-number">4.2.</span> <span class="toc-text">Use it on simple Bean</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Possible-Improvements"><span class="toc-number">5.</span> <span class="toc-text">Possible Improvements</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Summary"><span class="toc-number">6.</span> <span class="toc-text">Summary</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Source-code"><span class="toc-number">7.</span> <span class="toc-text">Source code</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Implementing annotation-based retrial mechanism on Spring Beans
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Kumasuke's Blog</span>
      </span>
      
    <div class="postdate">
        <time datetime="2018-06-02T08:52:00.000Z" itemprop="datePublished">2018-06-02</time>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/CGLib/">CGLib</a>, <a class="tag-link" href="/tags/Dynamic-Proxy/">Dynamic Proxy</a>, <a class="tag-link" href="/tags/Java/">Java</a>, <a class="tag-link" href="/tags/RetryOnFailure/">RetryOnFailure</a>, <a class="tag-link" href="/tags/Spring/">Spring</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <blockquote>
<p><em>Disclaimer</em>: Although this article is original, the annotation <code>@RetryOnFailure</code> mentioned within this article was inspired by <a href="https://aspects.jcabi.com/apidocs-0.22.6/com/jcabi/aspects/RetryOnFailure.html" target="_blank" rel="noopener"><code>@RetryOnFailure</code></a> in <code>jcabi-aspects</code>.</p>
</blockquote>
<p>In Spring Framework, we may often come across such a scenario when we need to retry within limited attempts to get resources from external resources (such as external API). However, the boilerplate retry code of writing <code>while</code> loop is so annoying to write. Actually, we could reduce such boilerplate code snippets into a simple annotation <code>@RetryOnFailure</code>.</p>
<h2 id="Definition-of-RetryOnFailure"><a href="#Definition-of-RetryOnFailure" class="headerlink" title="Definition of @RetryOnFailure"></a>Definition of <code>@RetryOnFailure</code></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Target</span>(ElementType.METHOD)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> RetryOnFailure &#123;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">attempts</span><span class="params">()</span> <span class="keyword">default</span> 3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">delay</span><span class="params">()</span> <span class="keyword">default</span> 1500</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">randomize</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">false</span></span>;</span><br><span class="line"></span><br><span class="line">    Class&lt;? extends Throwable&gt;[] retryFor() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    Class&lt;? extends Throwable&gt;[] ignoreFor() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>@RetryOnFailure</code> has five properties that make it fit into different use cases:</p>
<ul>
<li><code>attempts</code>: the total times to attempt, including the first attempt</li>
<li><code>delay</code>: delay between each attempts, in milliseconds</li>
<li><code>randomize</code>: <code>delay</code> will be the upper bound of random generating millisecond number if it’s <code>true</code>; otherwise, delay will be fixed at <code>delay</code></li>
<li><code>retryFor</code>: retrial will be triggered if it’s empty; retrial will be triggered only for specified <code>Throwable</code> otherwise</li>
<li><code>ignoreFor</code>: specified <code>Throwable</code> won’t be thrown in annotated methods even if retrial triggered for them</li>
</ul>
<p>But how could we implement such a mechanism? The answer is to take advantage of <a href="https://docs.oracle.com/javase/8/docs/technotes/guides/reflection/proxy.html" target="_blank" rel="noopener">dynamic proxy</a> and <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/beans/factory/config/BeanPostProcessor.html" target="_blank" rel="noopener"><code>BeanPostProcessor</code></a>.</p>
<h2 id="Meet-with-BeanPostProcessor"><a href="#Meet-with-BeanPostProcessor" class="headerlink" title="Meet with BeanPostProcessor"></a>Meet with <code>BeanPostProcessor</code></h2><p><code>BeanPostProcessor</code> is a ‘callback’ interface whose method will be invoked during bean preparation (picture source: <a href="http://javasampleapproach.com/spring-framework/spring-bean-post-processors" target="_blank" rel="noopener">Spring Bean Post Processors</a>):<br><img src="/img/2018/06/beanpostprocessor-overview.jpg" alt="Spring Bean Preparation"><br>Because dynamic proxy may hide some <code>private</code> fields of bean, we choose the method <code>BeanPostProcessor#postProcessAfterInitialization(Object, String)</code> in order to implement our requirement.</p>
<p>The idea of implementing our retrial mechanism is to create a new bean which applied the retrial ability on method annotated with <code>@RetryOnFailure</code>, and to swap the original bean with the newly-created one.</p>
<p>Here is the code template of our <code>RetryOnFailureBeanPostProcessor</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RetryOnFailureBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title">BeanPostProcessor</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> </span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Map&lt;MethodWrapper, RetryConfig&gt; methodToConfig = </span><br><span class="line">            getAnnotatedMethodToConfig(bean);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (hasMethodAnnotated(methodToConfig)) &#123;</span><br><span class="line">            <span class="keyword">return</span> enhanceBean(bean, methodToConfig);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> bean;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>From the code above, we can see through such a simple logic as follow:</p>
<ul>
<li>if the bean has any method annotated with <code>@RetryOnFailure</code>, enhance it with retrial mechanism and return</li>
<li>return the bean intact otherwise</li>
</ul>
<p>Therefore, we have to look at how to modify the original bean and add retrial mechanism.</p>
<h2 id="Enhance-Bean-with-retrial-mechanism"><a href="#Enhance-Bean-with-retrial-mechanism" class="headerlink" title="Enhance Bean with retrial mechanism"></a>Enhance Bean with retrial mechanism</h2><p>We will two kinds of approaches to enhance Bean in order to cope with two different situations. We will employ Java dynamic proxy when the bean is a interface-based one (such as a interface <code>XXXService</code> with a implementation called <code>XXXServiceImpl</code>), and use <a href="https://github.com/cglib/cglib" target="_blank" rel="noopener">CGLib</a> (the one that repackaged in Spring) to deal with the other situation.</p>
<p>Here is the basic structure of <code>private</code> method <code>enhanceBean</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">enhanceBean</span><span class="params">(Object bean, </span></span></span><br><span class="line"><span class="function"><span class="params">                           Map&lt;MethodWrapper, RetryConfig&gt; methodToConfig)</span> </span>&#123;</span><br><span class="line">    Class&lt;?&gt; beanClass = bean.getClass();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isInterfaceBasedBean(beanClass)) &#123;</span><br><span class="line">        <span class="keyword">return</span> enhanceWithProxy(bean, methodToConfig);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (Modifier.isFinal(beanClass.getModifiers())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(<span class="comment">/* ... */</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> enhanceWithCGLib(beanClass, methodToConfig);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>What the code above shows is exactly what we have talked in last paragraph. You may notice that <code>BeanCreationException</code> will be thrown if bean is an instance of a <code>final</code> class. That is because CGLib enhance a class by extending it and do corresponding modification, thus we will need to throw exception when we come across <code>final</code> class.</p>
<h3 id="Detect-interface-based-Bean"><a href="#Detect-interface-based-Bean" class="headerlink" title="Detect interface-based Bean"></a>Detect interface-based Bean</h3><p>Firstly, let’s write a basic method to decide which way we should employ to enhance bean.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isInterfaceBasedBean</span><span class="params">(Class&lt;?&gt; beanClass)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Class&lt;?&gt;[] interfaces = beanClass.getInterfaces();</span><br><span class="line">    <span class="keyword">return</span> interfaces.length != <span class="number">0</span> &amp;&amp;</span><br><span class="line">            !beanClass.getCanonicalName().startsWith(<span class="string">"java"</span>) &amp;&amp;</span><br><span class="line">            Stream.of(interfaces)</span><br><span class="line">                .anyMatch(i -&gt; !i.getCanonicalName().startsWith(<span class="string">"java"</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>To use dynamic proxy, the bean class should implement at least 1 interface. In addition, we will rule out the classes in the packages of <code>java</code> or <code>javax</code>, and we will also rule out interfaces that of the same pattern (such as <code>java.io.Serializable</code>). This detection is rather basic, but with the exclusion, we could make the bean as it is in most cases.</p>
<h3 id="Preparation-to-enhance-Bean"><a href="#Preparation-to-enhance-Bean" class="headerlink" title="Preparation to enhance Bean"></a>Preparation to enhance Bean</h3><h4 id="Extracts-annotated-methods"><a href="#Extracts-annotated-methods" class="headerlink" title="Extracts annotated methods"></a>Extracts annotated methods</h4><p>To enhance bean and make its annotated methods own retrial mechanism, we have to extract annotated methods:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RetryOnFailureBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title">BeanPostProcessor</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;MethodWrapper, RetryConfig&gt; </span><br><span class="line">        getAnnotatedMethodToConfig(Object bean) &#123;</span><br><span class="line">        <span class="keyword">if</span> (bean == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Collections.emptyMap();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> Method[] publicMethods = bean.getClass().getMethods();</span><br><span class="line">            <span class="keyword">final</span> Map&lt;MethodWrapper, RetryConfig&gt; result = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">            <span class="keyword">for</span> (Method m : publicMethods) &#123;</span><br><span class="line">                <span class="keyword">if</span> (Modifier.isStatic(m.getModifiers())) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">                RetryOnFailure rofAnnotation = </span><br><span class="line">                    m.getAnnotation(RetryOnFailure.class);</span><br><span class="line">                <span class="keyword">if</span> (rofAnnotation != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    result.put(<span class="keyword">new</span> MethodWrapper(m), </span><br><span class="line">                               <span class="keyword">new</span> RetryConfig(rofAnnotation));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> Collections.unmodifiableMap(result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="Helper-classes"><a href="#Helper-classes" class="headerlink" title="Helper classes"></a>Helper classes</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractRetryOnFailureBeanMethodCallback</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodWrapper</span> </span>&#123;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">final</span> Method method;</span><br><span class="line"></span><br><span class="line">            MethodWrapper(Method method) &#123;</span><br><span class="line">                <span class="keyword">this</span>.method = method;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span> == o) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">if</span> (o == <span class="keyword">null</span> || getClass() != o.getClass()) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">                MethodWrapper that = (MethodWrapper) o;</span><br><span class="line">                <span class="keyword">return</span> Objects.equals(method.getName(), </span><br><span class="line">                                      that.method.getName()) &amp;&amp;</span><br><span class="line">                        Arrays.equals(method.getParameterTypes(), </span><br><span class="line">                                      that.method.getParameterTypes()) &amp;&amp;</span><br><span class="line">                        Objects.equals(method.getReturnType(), </span><br><span class="line">                                       that.method.getReturnType());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> Objects.hash(method.getName(), </span><br><span class="line">                                    Arrays.hashCode(</span><br><span class="line">                                        method.getParameterTypes()</span><br><span class="line">                                    ),</span><br><span class="line">                                    method.getReturnType());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">RetryConfig</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> attempts;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> delay;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> randomize;</span><br><span class="line">        <span class="keyword">final</span> Set&lt;Class&lt;? extends Throwable&gt;&gt; retryFor;</span><br><span class="line">        <span class="keyword">final</span> Set&lt;Class&lt;? extends Throwable&gt;&gt; ignoreFor;</span><br><span class="line"></span><br><span class="line">        RetryConfig(RetryOnFailure rofAnnotation) &#123;</span><br><span class="line">            <span class="keyword">this</span>.attempts = rofAnnotation.attempts();</span><br><span class="line">            <span class="keyword">this</span>.delay = rofAnnotation.delay();</span><br><span class="line">            <span class="keyword">this</span>.randomize = rofAnnotation.randomize();</span><br><span class="line">            <span class="keyword">this</span>.retryFor = </span><br><span class="line">                Collections.unmodifiableSet(</span><br><span class="line">                    <span class="keyword">new</span> HashSet&lt;&gt;(</span><br><span class="line">                            Arrays.asList(rofAnnotation.retryFor())</span><br><span class="line">                    )</span><br><span class="line">                );</span><br><span class="line">            <span class="keyword">this</span>.ignoreFor = </span><br><span class="line">                Collections.unmodifiableSet(</span><br><span class="line">                    <span class="keyword">new</span> HashSet&lt;&gt;(</span><br><span class="line">                            Arrays.asList(rofAnnotation.ignoreFor())</span><br><span class="line">                    )</span><br><span class="line">                );  </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Here, from the code blocks above, we have seen three major parts, the wrapper class <code>AbstractRetryOnFailureBeanMethodCallback.MethodWrapper</code>, a retrial configuration class <code>AbstractRetryOnFailureBeanMethodCallback.RetryConfig</code>, and the <code>private</code> helper method <code>RetryOnFailureBeanPostProcessor#getAnnotatedMethodToConfig(Object)</code>.</p>
<p>Method <code>getAnnotatedMethodToConfig</code> reads the <code>Class</code> instance of bean and extracts all <code>@RetryOnFailure</code>-annotated method with newly-created <code>RetryConfig</code> into a <code>Map</code>.</p>
<p>To avoid declaring class in <code>Method#equals(Object)</code> (in case of classes created by proxy or sub-classing), we create <code>MethodWrapper</code> whose <code>equals</code> and <code>hashCode</code> method only checks the equalities of name, parameter types and return type.</p>
<h3 id="Common-parts-of-both-approaches"><a href="#Common-parts-of-both-approaches" class="headerlink" title="Common parts of both approaches"></a>Common parts of both approaches</h3><p>Both dynamic proxy and CGLib have same logic, we extract the common part of both ways into a <code>abstract</code> class <code>AbstractRetryOnFailureBeanMethodCallback</code>, which you have seen in the last section.</p>
<h4 id="Common-implementation-of-both-ways"><a href="#Common-implementation-of-both-ways" class="headerlink" title="Common implementation of both ways"></a>Common implementation of both ways</h4><p>Here is the basic structure of <code>AbstractRetryOnFailureBeanMethodCallback</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractRetryOnFailureBeanMethodCallback</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Random rand = <span class="keyword">new</span> SecureRandom();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;MethodWrapper, RetryConfig&gt; methodToConfig;</span><br><span class="line"></span><br><span class="line">    AbstractRetryOnFailureBeanMethodCallback(</span><br><span class="line">        Map&lt;MethodWrapper, RetryConfig&gt; methodToConfig</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="keyword">this</span>.methodToConfig = methodToConfig;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">Object <span class="title">doCallback</span><span class="params">(MethodWrapper calledMethod, MethodInvoker invoker)</span> </span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (methodToConfig.containsKey(calledMethod)) &#123;</span><br><span class="line">            RetryConfig conf = methodToConfig.get(calledMethod);</span><br><span class="line">            <span class="keyword">return</span> invokeWithRetry(invoker, conf);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> invoker.invoke();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Object <span class="title">invokeWithRetry</span><span class="params">(MethodInvoker invoker, RetryConfig conf)</span> </span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="comment">// to be implemented...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@FunctionalInterface</span></span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">MethodInvoker</span>&lt;<span class="title">R</span>&gt; </span>&#123;</span><br><span class="line">        <span class="function">R <span class="title">invoke</span><span class="params">()</span> <span class="keyword">throws</span> Throwable</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>doCallback</code> is the main method of the whole class. It first checks whether the method called is annotated with <code>@RetryOnConfig</code> (by testing if <code>calledMethod</code> in the keySet of <code>methodToConfig</code>). If the <code>calledMethod</code> is annotated with <code>@RetryOnConfig</code>, we will invoke it under retrial mechanism. Otherwise, we will just invoke it normally.</p>
<h4 id="Implement-of-invokeWithRetry"><a href="#Implement-of-invokeWithRetry" class="headerlink" title="Implement of invokeWithRetry"></a>Implement of <code>invokeWithRetry</code></h4><p>In <code>invokeWithRetry</code>, we mainly invoke method in a <code>while</code> loop. We keep trying until the given method returns normally or exceeds the number set by <code>attempts</code>.  We will throw the last exception thrown in the method if it couldn’t return successfully.</p>
<p>Here is how we implement the <code>invokeWithRetry</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">invokeWithRetry</span><span class="params">(MethodInvoker invoker, RetryConfig conf)</span> </span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> retryCount = <span class="number">0</span>;</span><br><span class="line">    Exception lastThrown = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (retryCount++ &lt; conf.attempts) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> invoker.invoke();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!conf.retryFor.isEmpty() &amp;&amp; </span><br><span class="line">                !conf.retryFor.contains(e.getClass())) &#123;</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (lastThrown == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    lastThrown = </span><br><span class="line">                        conf.ignoreFor.contains(e.getClass()) ? <span class="keyword">null</span> : e;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    e.addSuppressed(lastThrown);</span><br><span class="line">                    lastThrown = e;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    waitForRetry(conf);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException ie) &#123;</span><br><span class="line">                    e.addSuppressed(ie);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (lastThrown == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> lastThrown;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">waitForRetry</span><span class="params">(RetryConfig conf)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (conf.randomize) &#123;</span><br><span class="line">        Thread.sleep(Math.abs(rand.nextLong()) % conf.delay + <span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Thread.sleep(conf.delay);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>The code above is almost same as what we have talked. We put the method invocation in a <code>while</code> loop and catch exception which we care about in order to let retrial begin. You may also notice that we only catch <code>Exception</code> but <code>Throwable</code> cause catching <code>Error</code> is not recommended. In addition, we call <code>addSuppressed</code> to record former exceptions.</p>
<p>Until now, we finished implementing the most important part of the retrial mechanism. What remains is only wire all these basic components up.</p>
<h3 id="Enhance-Bean-with-dynamic-proxy"><a href="#Enhance-Bean-with-dynamic-proxy" class="headerlink" title="Enhance Bean with dynamic proxy"></a>Enhance Bean with dynamic proxy</h3><p>Let’s implement approach that employ dynamic proxy first. Here is the skeleton of enhance Bean in the <code>RetryOnFailureBeanPostProcessor</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RetryOnFailureBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title">BeanPostProcessor</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">private</span> Object enhanceWithProxy</span><br><span class="line">        (Object bean, Map&lt;MethodWrapper, RetryConfig&gt; methodToConfig) &#123;</span><br><span class="line">        <span class="keyword">final</span> Class&lt;?&gt; beanClass = bean.getClass();</span><br><span class="line">        <span class="keyword">final</span> RetryOnFailureBeanInvocationHandler handler =</span><br><span class="line">                <span class="keyword">new</span> RetryOnFailureBeanInvocationHandler(bean, methodToConfig);</span><br><span class="line">        <span class="keyword">return</span> Proxy.newProxyInstance(beanClass.getClassLoader(),</span><br><span class="line">                                      beanClass.getInterfaces(),</span><br><span class="line">                                      handler);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>It is easy to understand that <code>RetryOnFailureBeanInvocationHandler</code> is the important part of the whole part. What the <code>handler</code> does is to intercept method invocation on the proxy object and do what we want accordingly. We could use the former implementation of <code>AbstractRetryOnFailureBeanMethodCallback</code> to finish it.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RetryOnFailureBeanInvocationHandler</span> </span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">AbstractRetryOnFailureBeanMethodCallback</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object bean;</span><br><span class="line"></span><br><span class="line">    RetryOnFailureBeanInvocationHandler</span><br><span class="line">        (Object bean, Map&lt;MethodWrapper, RetryConfig&gt; methodToConfig) &#123;</span><br><span class="line">        <span class="keyword">super</span>(methodToConfig);</span><br><span class="line">        <span class="keyword">this</span>.bean = bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> </span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        Object retVal = doCallback(<span class="keyword">new</span> MethodWrapper(method), () -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> method.invoke(bean, args);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> e.getTargetException();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; retType = method.getReturnType();</span><br><span class="line">        <span class="keyword">if</span> (retVal == <span class="keyword">null</span> &amp;&amp; retType.isPrimitive()) &#123;</span><br><span class="line">            <span class="keyword">return</span> getDefaultValueForPrimitive(retType);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> retVal;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>You can see, the method invocation is quite straightforward, we just invoke the method use reflection. But in addition, we catch the <code>InvocationTargetException</code>, which is to prevent <code>UndeclaredThrowableException</code> which will be thrown if the checked exception thrown in <code>invoke</code> method of <code>InvocationHandler</code> is not declared in the method signature (i.e. <code>InvocationTargetException</code>).<br>Moreover, the <code>doCallback</code> will return <code>null</code> if all exceptions thrown in the method invocation are ignored and retrial limit is exceeded. To cope with this situation, we need to return default value for return value that of <a href="https://docs.oracle.com/javase/tutorial/java/nutsandbolts/datatypes.html" target="_blank" rel="noopener">primitive types</a> (including <code>void</code>, which we could return <code>null</code>). So <code>getDefaultValueForPrimitive</code> does this job, and we omit it to keep code block succinct.</p>
<p>That’s how we implement the dynamic proxy way. Let’s implement CGLib way to wrap it up next.</p>
<h3 id="Enhance-Bean-with-CGLib"><a href="#Enhance-Bean-with-CGLib" class="headerlink" title="Enhance Bean with CGLib"></a>Enhance Bean with CGLib</h3><p>The CGLib is quite simple cause most of works are done by the CGLib library (including default value of primitive types). All we need to do is just implement the <code>MethodInterceptor</code>, and use it in the <code>RetryOnFailureBeanPostProcessor</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RetryOnFailureBeanMethodInterceptor</span> </span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">AbstractRetryOnFailureBeanMethodCallback</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">MethodInterceptor</span> </span>&#123;</span><br><span class="line">    RetryOnFailureBeanMethodInterceptor</span><br><span class="line">        (Map&lt;MethodWrapper, RetryConfig&gt; methodToConfig) &#123;</span><br><span class="line">        <span class="keyword">super</span>(methodToConfig);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object object, Method method, </span></span></span><br><span class="line"><span class="function"><span class="params">                            Object[] args, MethodProxy proxy)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> doCallback(<span class="keyword">new</span> MethodWrapper(method), </span><br><span class="line">                          () -&gt; proxy.invokeSuper(object, args));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RetryOnFailureBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title">BeanPostProcessor</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">private</span> Object enhanceWithCGLib</span><br><span class="line">        (Class&lt;?&gt; beanClass, Map&lt;MethodWrapper, RetryConfig&gt; methodToConfig) &#123;</span><br><span class="line">        <span class="keyword">final</span> RetryOnFailureBeanMethodInterceptor interceptor =</span><br><span class="line">                <span class="keyword">new</span> RetryOnFailureBeanMethodInterceptor(methodToConfig);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Enhancer enhancer = <span class="keyword">new</span> Enhancer();</span><br><span class="line">        enhancer.setSuperclass(beanClass);</span><br><span class="line">        enhancer.setCallback(interceptor);</span><br><span class="line">        <span class="keyword">return</span> enhancer.create();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>At this point, we have implemented the whole retrial mechanism. Let’s write some code to try it out.</p>
<h2 id="Try-RetryOnFailure"><a href="#Try-RetryOnFailure" class="headerlink" title="Try @RetryOnFailure"></a>Try <code>@RetryOnFailure</code></h2><h3 id="Use-it-on-a-interfaced-based-Service"><a href="#Use-it-on-a-interfaced-based-Service" class="headerlink" title="Use it on a interfaced-based @Service"></a>Use it on a interfaced-based <code>@Service</code></h3><p>Let’s write a RESTful API to test it, here is the sample code:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UnreliableService</span> </span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">sayHello</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UnreliableServiceImpl</span> <span class="keyword">implements</span> <span class="title">UnreliableService</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@RetryOnFailure</span>(attempts = <span class="number">5</span>, delay = <span class="number">300</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (Math.random() &lt; <span class="number">0.5</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"Hello World!"</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ServiceUnavailableException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UnreliableService service;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HelloController</span><span class="params">(UnreliableService service)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.service = service;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/say-hello"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Collections.singletonMap(<span class="string">"message"</span>, service.sayHello());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title">handleException</span><span class="params">(Exception e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Collections.singletonMap(<span class="string">"exception"</span>, </span><br><span class="line">                                        e.getClass().getCanonicalName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We could test it with the following code:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> REPEAT_TIME = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> successTime = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; REPEAT_TIME; i++) &#123;</span><br><span class="line">        <span class="keyword">long</span> startAt = System.currentTimeMillis();</span><br><span class="line">        MvcResult result = mockMvc.perform(get(<span class="string">"/say-hello"</span>))</span><br><span class="line">                .andDo(print())</span><br><span class="line">                .andExpect(status().isOk())</span><br><span class="line">                .andReturn();</span><br><span class="line">        <span class="keyword">long</span> endAt = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">boolean</span> success = isSuccessful(result);</span><br><span class="line">        <span class="keyword">if</span> (success) successTime += <span class="number">1</span>;</span><br><span class="line">        System.out.printf(<span class="string">"[%03d] success: %b, cost time: %d ms%n"</span>,</span><br><span class="line">                            i, success, (endAt - startAt));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    System.out.printf(<span class="string">"[summary] total: %d, success: %d%n"</span>, </span><br><span class="line">                      REPEAT_TIME, successTime);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>The result of executing the test is as follow:<br><img src="/img/2018/06/test-say-hello.png" alt="Test say-hello"></p>
<p>What we can see from the result is the success count is way higher than 50 even if the success rate of single invoke of <code>UnreliableService#sayHello()</code>is 50%. That is obviously the result of <code>@RetryOnFailure</code> which we want.</p>
<h3 id="Use-it-on-simple-Bean"><a href="#Use-it-on-simple-Bean" class="headerlink" title="Use it on simple Bean"></a>Use it on simple Bean</h3><p>Let’s write a simple Bean to try out <code>@RetryOnFailure</code> and write a RESTful API <code>GET /say-hello-from-foreigners</code> to call it:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UnreliableApiCaller</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RetryOnFailure</span>(randomize = <span class="keyword">true</span>, retryFor = IOException.class)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHelloFromForeigners</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (Math.random() &lt; <span class="number">0.3</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"你好，世界！"</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (Math.random() &lt; <span class="number">0.2</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IOException();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>The code above is to mimic an unreliable third party API. We omit the <code>@Service</code> and <code>@RestController</code> methods here to save space. Let’s test it with the following code, which is basically same as the <code>@Test</code> method above:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sayHelloFromForeigners</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> REPEAT_TIME = <span class="number">50</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> successTime = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; REPEAT_TIME; i++) &#123;</span><br><span class="line">        <span class="keyword">long</span> startAt = System.currentTimeMillis();</span><br><span class="line">        MvcResult result = mockMvc.perform(get(<span class="string">"/say-hello-from-foreigners"</span>))</span><br><span class="line">                .andDo(print())</span><br><span class="line">                .andExpect(status().isOk())</span><br><span class="line">                .andReturn();</span><br><span class="line">        <span class="keyword">long</span> endAt = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">boolean</span> success = isSuccessful(result);</span><br><span class="line">        <span class="keyword">if</span> (success) successTime += <span class="number">1</span>;</span><br><span class="line">        System.out.printf(<span class="string">"[%03d] success: %b, cost time: %d ms%n"</span>,</span><br><span class="line">                          i, success, (endAt - startAt));</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    System.out.printf(<span class="string">"[summary] total: %d, success: %d%n"</span>, </span><br><span class="line">                    REPEAT_TIME, successTime);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><img src="/img/2018/06/test-say-hello-from-foreigners.png" alt="Test say-hello-from-foreigners"></p>
<p>The result above also shows that our retrial mechanism works.</p>
<h2 id="Possible-Improvements"><a href="#Possible-Improvements" class="headerlink" title="Possible Improvements"></a>Possible Improvements</h2><p>Actually, the mechanism we have implemented is only support non-static <code>public</code> methods. This is not only because we use <code>Class#getMethods()</code> to detected methods, but also the dynamic proxy only support on interfaces tier.<br>On the other hand, if we use CGLib to enhance our Beans in all circumstances, we may solve former-mentioned problem but could not support <code>final</code> class in the case of interface-based Bean.<br>After all, which way you take is just at your disposal.</p>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>In this article, we implemented annotation-based retrial mechanism on Spring. This may inspire you in other ways. You could use this technique to implement other useful mechanism or even improve the architecture of your application.</p>
<h2 id="Source-code"><a href="#Source-code" class="headerlink" title="Source code"></a>Source code</h2><p>You could get the code of the sample project at <a href="https://github.com/kumasuke120/retry-on-failure" target="_blank" rel="noopener">here</a>.</p>

  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Definition-of-RetryOnFailure"><span class="toc-number">1.</span> <span class="toc-text">Definition of @RetryOnFailure</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Meet-with-BeanPostProcessor"><span class="toc-number">2.</span> <span class="toc-text">Meet with BeanPostProcessor</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Enhance-Bean-with-retrial-mechanism"><span class="toc-number">3.</span> <span class="toc-text">Enhance Bean with retrial mechanism</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Detect-interface-based-Bean"><span class="toc-number">3.1.</span> <span class="toc-text">Detect interface-based Bean</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Preparation-to-enhance-Bean"><span class="toc-number">3.2.</span> <span class="toc-text">Preparation to enhance Bean</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Extracts-annotated-methods"><span class="toc-number">3.2.1.</span> <span class="toc-text">Extracts annotated methods</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Helper-classes"><span class="toc-number">3.2.2.</span> <span class="toc-text">Helper classes</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Common-parts-of-both-approaches"><span class="toc-number">3.3.</span> <span class="toc-text">Common parts of both approaches</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Common-implementation-of-both-ways"><span class="toc-number">3.3.1.</span> <span class="toc-text">Common implementation of both ways</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Implement-of-invokeWithRetry"><span class="toc-number">3.3.2.</span> <span class="toc-text">Implement of invokeWithRetry</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Enhance-Bean-with-dynamic-proxy"><span class="toc-number">3.4.</span> <span class="toc-text">Enhance Bean with dynamic proxy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Enhance-Bean-with-CGLib"><span class="toc-number">3.5.</span> <span class="toc-text">Enhance Bean with CGLib</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Try-RetryOnFailure"><span class="toc-number">4.</span> <span class="toc-text">Try @RetryOnFailure</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Use-it-on-a-interfaced-based-Service"><span class="toc-number">4.1.</span> <span class="toc-text">Use it on a interfaced-based @Service</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Use-it-on-simple-Bean"><span class="toc-number">4.2.</span> <span class="toc-text">Use it on simple Bean</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Possible-Improvements"><span class="toc-number">5.</span> <span class="toc-text">Possible Improvements</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Summary"><span class="toc-number">6.</span> <span class="toc-text">Summary</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Source-code"><span class="toc-number">7.</span> <span class="toc-text">Source code</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://blog.kumasuke.app/2018/06/02/implementing-annotation-based-retrial-mechanism-on-spring-beans/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://blog.kumasuke.app/2018/06/02/implementing-annotation-based-retrial-mechanism-on-spring-beans/&text=Implementing annotation-based retrial mechanism on Spring Beans"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://blog.kumasuke.app/2018/06/02/implementing-annotation-based-retrial-mechanism-on-spring-beans/&title=Implementing annotation-based retrial mechanism on Spring Beans"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://blog.kumasuke.app/2018/06/02/implementing-annotation-based-retrial-mechanism-on-spring-beans/&is_video=false&description=Implementing annotation-based retrial mechanism on Spring Beans"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Implementing annotation-based retrial mechanism on Spring Beans&body=Check out this article: https://blog.kumasuke.app/2018/06/02/implementing-annotation-based-retrial-mechanism-on-spring-beans/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://blog.kumasuke.app/2018/06/02/implementing-annotation-based-retrial-mechanism-on-spring-beans/&title=Implementing annotation-based retrial mechanism on Spring Beans"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://blog.kumasuke.app/2018/06/02/implementing-annotation-based-retrial-mechanism-on-spring-beans/&title=Implementing annotation-based retrial mechanism on Spring Beans"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://blog.kumasuke.app/2018/06/02/implementing-annotation-based-retrial-mechanism-on-spring-beans/&title=Implementing annotation-based retrial mechanism on Spring Beans"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://blog.kumasuke.app/2018/06/02/implementing-annotation-based-retrial-mechanism-on-spring-beans/&title=Implementing annotation-based retrial mechanism on Spring Beans"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://blog.kumasuke.app/2018/06/02/implementing-annotation-based-retrial-mechanism-on-spring-beans/&name=Implementing annotation-based retrial mechanism on Spring Beans&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2018 Kumasuke
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/fontawesome-all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'kumasuke-blog';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


